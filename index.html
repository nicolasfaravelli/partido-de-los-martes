<script>
    // ====================================================================
    //   1. ZONA DE CONFIGURACI칍N GENERAL (URLS Y RECURSOS)
    // ====================================================================
    
    const FONDO_URL = "https://raw.githubusercontent.com/nicolasfaravelli/partido-de-los-martes/main/Fondo.png"; 
    const TITULO_IMG_URL = "https://raw.githubusercontent.com/nicolasfaravelli/partido-de-los-martes/main/Titulo.png";
    const MUSICA_URL = "https://raw.githubusercontent.com/nicolasfaravelli/partido-de-los-martes/main/Musica.mp3";
    const LEYENDA_FONDO_URL = "https://raw.githubusercontent.com/nicolasfaravelli/partido-de-los-martes/main/LEYENDA.png";

    const NEW_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTHOyW-OmPwPBpIwBw30sBjYdcLn1_8xFjkXfG9_tLFeB960jfYnnouTDieGPeKSK49FYM1tSGng_mg/pub?gid=1826229647&single=true&output=csv";
    const PROXY_URL = "https://corsproxy.io/?" + encodeURIComponent(NEW_CSV_URL);

    // ====================================================================
    //   1.1. CONFIGURACI칍N DE COLORES
    // ====================================================================
    const COLORES = { 
        'leyenda': '#644b14',    // Color Texto Leyenda
        'legendario': '#392266', 
        'oro': '#624f21', 
        'plata': '#434343', 
        'bronce': '#5e3e21'
    };

    // ====================================================================
    //   1.2. CONFIGURACI칍N MATEM츼TICA LEYENDA (EDITAR AQU칈 LOS VALORES)
    // ====================================================================
    
    // Multiplicadores seg칰n el orden de sus stats (Del mejor al peor)
    // 1췈 mejor stat se multiplica por 1.35, el 2췈 por 1.30, etc.
    const MULTIPLICADORES_RANKING = [1.35, 1.30, 1.25, 1.15, 1.10, 1.05]; 

    // Bonus extra acumulativo para stats f칤sicos (se aplica DESPU칄S del ranking)
    const BONUS_FISICO = { 
        'res': 1.10, // Resistencia x 1.1 extra
        'vel': 1.05  // Velocidad x 1.05 extra
    };

    const TOPE_MAXIMO = 97; // Ning칰n stat superar치 este valor

    // ====================================================================
    //   2. L칍GICA DEL SISTEMA
    // ====================================================================

    if(FONDO_URL) document.documentElement.style.setProperty('--fondo-url', `url('${FONDO_URL}')`);
    if(TITULO_IMG_URL) document.getElementById('header-area').innerHTML = `<img src="${TITULO_IMG_URL}" class="title-img" alt="Logo">`;
    if(MUSICA_URL) document.getElementById('audio-player').src = MUSICA_URL; else document.querySelector('.music-btn').style.display = 'none';

    let datosOriginales = []; 
    let datosFiltrados = [];  

    // CARGA DE DATOS
    Papa.parse(PROXY_URL, {
        download: true, header: false, skipEmptyLines: true,
        complete: function(results) {
            const data = results.data;
            document.getElementById('loader').style.display = 'none';
            if(data.length > 0) data.shift(); 

            datosOriginales = data.map((fila, index) => {
                const nombre = fila[0]; 
                if(!nombre || nombre === 'Jugador') return null;
                
                let tipoCarta = fila[10] ? fila[10].trim().toLowerCase() : 'oro';
                let colorTexto = COLORES[tipoCarta] || '#624f21'; 

                return {
                    id: index,
                    nombre: nombre,
                    edad: parseInt(fila[1]) || 25, 
                    ata: parseInt(fila[2]) || 0, def: parseInt(fila[3]) || 0, tec: parseInt(fila[4]) || 0, 
                    vel: parseInt(fila[5]) || 0, res: parseInt(fila[6]) || 0, arq: parseInt(fila[7]) || 0,
                    prom: parseInt(fila[8]) || 0, pos: fila[9] ? fila[9].trim() : "",
                    fondo: fila[11] ? fila[11].trim() : "", foto: fila[12] ? fila[12].trim() : "",
                    fotoLeyenda: fila[13] ? fila[13].trim() : "", 
                    color: colorTexto,
                    tipoBase: tipoCarta
                };
            }).filter(item => item !== null); 

            datosFiltrados = [...datosOriginales];
            aplicarFiltrosYOrden();
        }
    });

    // FILTROS
    const searchInput = document.getElementById('search-input');
    const sortSelect = document.getElementById('sort-select');
    searchInput.addEventListener('input', aplicarFiltrosYOrden);
    sortSelect.addEventListener('change', aplicarFiltrosYOrden);
    
    function aplicarFiltrosYOrden() {
        const textoBusqueda = searchInput.value.toLowerCase();
        const criterioFull = sortSelect.value.split('-'); 
        const criterio = criterioFull[0];
        const orden = criterioFull[1];

        datosFiltrados = datosOriginales.filter(j => j.nombre.toLowerCase().includes(textoBusqueda));

        datosFiltrados.sort((a, b) => {
            if (criterio === 'nombre' || criterio === 'pos') return orden === 'asc' ? a[criterio].localeCompare(b[criterio]) : b[criterio].localeCompare(a[criterio]);
            return orden === 'asc' ? a[criterio] - b[criterio] : b[criterio] - a[criterio];
        });
        renderizarGrilla(datosFiltrados);
    }

    function renderizarGrilla(lista) {
        const container = document.getElementById('grid-container');
        container.innerHTML = '';
        if(lista.length === 0) { container.innerHTML = '<p style="text-align:center; width:100%; color:#aaa;">No se encontraron jugadores.</p>'; return; }
        lista.forEach(jugadorObj => {
            const html = `<div class="card" onclick="abrirModalPorID(${jugadorObj.id})">${generarHTMLCarta(jugadorObj, true)}</div>`;
            container.innerHTML += html;
        });
    }

    function generarHTMLCarta(j, lazy = false) {
        const loadingAttr = lazy ? 'loading="lazy"' : '';
        const fotoHtml = j.foto ? `<img src="${j.foto}" class="card-face" ${loadingAttr} crossorigin="anonymous">` : '';
        return `
            <div class="card-bg-wrapper"><img src="${j.fondo}" class="card-bg" ${loadingAttr} referrerpolicy="no-referrer" crossorigin="anonymous"></div>
            <div class="shine-layer" style="-webkit-mask-image: url('${j.fondo}'); mask-image: url('${j.fondo}');"></div>
            ${fotoHtml}
            <div class="info-layer">
                <div class="rating" style="color: ${j.color}">${j.prom}</div>
                <div class="position" style="color: ${j.color}">${j.pos}</div>
                <div class="name" style="color: ${j.color}">${j.nombre}</div>
                <div class="stats-container" style="color: ${j.color}">
                    <div class="stat-box"><span class="stat-val">${j.ata}</span></div>
                    <div class="stat-box"><span class="stat-val">${j.def}</span></div>
                    <div class="stat-box"><span class="stat-val">${j.tec}</span></div>
                    <div class="stat-box"><span class="stat-val">${j.vel}</span></div>
                    <div class="stat-box"><span class="stat-val">${j.res}</span></div>
                    <div class="stat-box"><span class="stat-val">${j.arq}</span></div>
                </div>
            </div>
        `;
    }

    // ====================================================================
    //   3. MODAL, LEYENDA Y L칍GICA DE MULTIPLICADORES
    // ====================================================================
    let jugadorActualEnModal = null;
    let esModoLeyenda = false;

    function abrirModalPorID(idReal) {
        const jugador = datosOriginales.find(j => j.id === idReal);
        if(!jugador) return;
        
        jugadorActualEnModal = jugador;
        esModoLeyenda = false; 
        renderizarModal(jugador);
        document.getElementById('modal').style.display = 'flex';
    }

    function renderizarModal(j) {
        const modalContainer = document.getElementById('modal-card-container');
        const modalButtons = document.getElementById('modal-buttons');
        modalContainer.innerHTML = `<div class="card" id="carta-para-descargar">${generarHTMLCarta(j, false)}</div>`;
        
        let botonesHTML = `
            <button class="btn-standard" onclick="cerrarModal()">CERRAR</button>
            <button class="btn-standard btn-action" onclick="descargarCarta()">DESCARGAR</button>
        `;

        if (jugadorActualEnModal.fotoLeyenda) {
            if (esModoLeyenda) {
                botonesHTML += `<button class="btn-standard" onclick="toggleLeyenda()">ACTUAL</button>`;
            } else {
                botonesHTML += `<button class="btn-standard btn-legend" onclick="toggleLeyenda()">LEYENDA</button>`;
            }
        }
        modalButtons.innerHTML = botonesHTML;
    }

    // --- C츼LCULO DE STATS LEYENDA (NUEVA L칍GICA) ---
    function calcularObjetoLeyenda(base) {
        // 1. Extraemos los stats en un array para poder ordenarlos
        let statsArray = [
            { id: 'ata', valor: base.ata },
            { id: 'def', valor: base.def },
            { id: 'tec', valor: base.tec },
            { id: 'vel', valor: base.vel },
            { id: 'res', valor: base.res },
            { id: 'arq', valor: base.arq }
        ];

        // 2. Ordenamos de MAYOR A MENOR valor
        statsArray.sort((a, b) => b.valor - a.valor);

        // 3. Objeto temporal para guardar los nuevos valores
        let nuevosValores = {};

        // 4. Aplicamos multiplicadores seg칰n posici칩n en el ranking
        statsArray.forEach((statObj, index) => {
            // Obtenemos el multiplicador correspondiente a su posici칩n (0 es el 1췈)
            // Si el array de multiplicadores es m치s corto, usamos el 칰ltimo disponible
            let multiplicador = MULTIPLICADORES_RANKING[index] || 1.05;
            
            let valorCalculado = statObj.valor * multiplicador;

            // 5. Aplicamos Bonus F칤sico (si corresponde)
            if (BONUS_FISICO[statObj.id]) {
                valorCalculado = valorCalculado * BONUS_FISICO[statObj.id];
            }

            // 6. Aplicamos Redondeo y Tope
            nuevosValores[statObj.id] = Math.min(TOPE_MAXIMO, Math.round(valorCalculado));
        });

        // 7. Calculamos el nuevo promedio (Suma de los 6 nuevos stats dividido 6)
        let suma = 0;
        for (let key in nuevosValores) {
            suma += nuevosValores[key];
        }
        let nuevoPromedio = Math.min(99, Math.round(suma / 6));

        // 8. Retornamos el objeto completo con los cambios
        return {
            ...base,
            foto: base.fotoLeyenda,
            fondo: LEYENDA_FONDO_URL,
            color: COLORES['leyenda'], // Color espec칤fico
            ata: nuevosValores.ata,
            def: nuevosValores.def,
            tec: nuevosValores.tec,
            vel: nuevosValores.vel,
            res: nuevosValores.res,
            arq: nuevosValores.arq,
            prom: nuevoPromedio
        };
    }

    function toggleLeyenda() {
        esModoLeyenda = !esModoLeyenda;
        let jugadorParaMostrar;

        if (esModoLeyenda) {
            jugadorParaMostrar = calcularObjetoLeyenda(jugadorActualEnModal);
        } else {
            jugadorParaMostrar = jugadorActualEnModal;
        }
        
        renderizarModal(jugadorParaMostrar);
        
        // EFECTO DE TRANSICI칍N: DISPARAR BRILLO
        const cardElement = document.getElementById('carta-para-descargar');
        cardElement.classList.remove('trigger-shine'); 
        void cardElement.offsetWidth; 
        cardElement.classList.add('trigger-shine'); 
    }

    function cerrarModal() { document.getElementById('modal').style.display = 'none'; }
    
    function descargarCarta() {
        const elemento = document.getElementById('carta-para-descargar');
        const btn = document.querySelector('.btn-action');
        btn.innerText = "PROCESANDO...";
        const shine = elemento.querySelector('.shine-layer');
        if(shine) shine.style.display = 'none';
        html2canvas(elemento, { useCORS: true, allowTaint: true, backgroundColor: null, scale: 3 }).then(canvas => {
            const link = document.createElement('a'); link.download = `FUT_Carta_${Date.now()}.png`; link.href = canvas.toDataURL("image/png"); link.click();
            btn.innerText = "DESCARGAR"; if(shine) shine.style.display = 'block';
        }).catch(err => { alert("Error: " + err); btn.innerText = "ERROR"; if(shine) shine.style.display = 'block'; });
    }
    
    document.addEventListener('keydown', function(event) { if (event.key === "Escape") { cerrarModal(); cerrarArmador(); } });

    // =========================================
    //   4. AUDIO Y EXTRAS
    // =========================================
    const audioPlayer = document.getElementById('audio-player');
    const musicBtn = document.querySelector('.music-btn');
    const musicIcon = document.getElementById('music-icon');
    let isPlaying = false;
    function toggleMusic() {
        if(!audioPlayer.src) return; 
        if (isPlaying) { audioPlayer.pause(); musicIcon.innerText = "游댇"; musicBtn.classList.remove('playing'); isPlaying = false; }
        else { audioPlayer.volume = 0.3; audioPlayer.play().then(() => { musicIcon.innerText = "游댉"; musicBtn.classList.add('playing'); isPlaying = true; }).catch(e => console.log("Bloqueo audio", e)); }
    }
    function activarModoRetro() { document.body.classList.toggle('retro-mode'); }

    // =========================================
    //   5. ARMADOR DE EQUIPOS 
    // =========================================
    function abrirArmador() {
        const list = document.getElementById('players-checklist');
        list.innerHTML = '';
        const sorted = [...datosOriginales].sort((a,b) => a.nombre.localeCompare(b.nombre));
        
        sorted.forEach(j => {
            list.innerHTML += `
            <label class="player-row" id="row-${j.id}">
                <input type="checkbox" class="player-check" value="${j.id}" onclick="controlarLimite(this)">
                <span>${j.nombre}</span>
            </label>`;
        });
        
        document.getElementById('team-results').style.display = 'none';
        document.getElementById('btn-share-teams').style.display = 'none';
        document.getElementById('team-modal').style.display = 'flex';
        actualizarContador(0);
    }

    function cerrarArmador() { document.getElementById('team-modal').style.display = 'none'; }

    function controlarLimite(checkbox) {
        const checked = document.querySelectorAll('.player-check:checked');
        const count = checked.length;
        document.getElementById('btn-generate').innerText = "GENERAR EQUIPOS";
        actualizarContador(count);
        if (count >= 10) {
            document.querySelectorAll('.player-check:not(:checked)').forEach(cb => {
                cb.disabled = true; document.getElementById(`row-${cb.value}`).classList.add('disabled');
            });
        } else {
            document.querySelectorAll('.player-check').forEach(cb => {
                cb.disabled = false; document.getElementById(`row-${cb.value}`).classList.remove('disabled');
            });
        }
    }

    function actualizarContador(count) {
        const missing = 10 - count;
        const counterLabel = document.getElementById('team-counter');
        const generateBtn = document.getElementById('btn-generate');
        if (missing > 0) {
            counterLabel.innerText = `FALTAN ${missing} JUGADORES`; counterLabel.style.color = "#888"; 
            generateBtn.classList.remove('active');
        } else if (missing === 0) {
            counterLabel.innerText = "춰LISTO! (10/10)"; counterLabel.style.color = "var(--color-acento)"; 
            generateBtn.classList.add('active');
        } else {
            counterLabel.innerText = "DEMASIADOS JUGADORES";
        }
    }

    // COLOR POR PROMEDIO (Para la lista de equipos)
    function getRatingColor(val) {
        if (val >= 90) return 'var(--stat-legend)'; 
        if (val >= 80) return 'var(--stat-gold)';
        if (val >= 70) return 'var(--stat-silver)'; 
        return 'var(--stat-bronze)';
    }

    function getPlayerHTML(p, isWhite) {
        const colorNota = getRatingColor(p.prom);
        const emoji = isWhite ? '郊勇' : '郊쀮잺';
        return `
        <div class="team-list-item">
            <span>${emoji} ${p.nombre}</span>
            <strong style="color:${colorNota}">${p.prom}</strong>
        </div>`;
    }

    function generarEquipos() {
        const checkboxes = document.querySelectorAll('.player-check:checked');
        const selectedIds = Array.from(checkboxes).map(cb => parseInt(cb.value));
        
        document.getElementById('btn-generate').innerText = "REGENERAR EQUIPOS";

        let pool = datosOriginales.filter(j => selectedIds.includes(j.id));
        let teamA = []; let teamB = []; let scoreA = 0; let scoreB = 0;

        pool.sort((a, b) => b.arq - a.arq);
        let portero1 = pool[0];
        let portero2 = pool[1];
        let resto = pool.slice(2);

        teamA.push(portero1); scoreA += getImpactScore(portero1);
        teamB.push(portero2); scoreB += getImpactScore(portero2);

        resto.sort((a, b) => {
            let impactA = getImpactScore(a) + (Math.random() * 4 - 2); 
            let impactB = getImpactScore(b) + (Math.random() * 4 - 2);
            return impactB - impactA;
        });

        resto.forEach(p => {
            let impact = getImpactScore(p);
            if (scoreA <= scoreB) { teamA.push(p); scoreA += impact; } 
            else { teamB.push(p); scoreB += impact; }
        });

        let finalTeam1, finalTeam2;
        if (Math.random() > 0.5) {
            finalTeam1 = { data: teamA, prom: calcularPromedioReal(teamA) };
            finalTeam2 = { data: teamB, prom: calcularPromedioReal(teamB) };
        } else {
            finalTeam1 = { data: teamB, prom: calcularPromedioReal(teamB) };
            finalTeam2 = { data: teamA, prom: calcularPromedioReal(teamA) };
        }

        finalTeam1.data.sort((a,b) => a.nombre.localeCompare(b.nombre));
        finalTeam2.data.sort((a,b) => a.nombre.localeCompare(b.nombre));

        document.getElementById('list-team-1').innerHTML = finalTeam1.data.map(p => getPlayerHTML(p, true)).join('');
        document.getElementById('avg-team-1').innerText = `Prom: ${finalTeam1.prom}`;

        document.getElementById('list-team-2').innerHTML = finalTeam2.data.map(p => getPlayerHTML(p, false)).join('');
        document.getElementById('avg-team-2').innerText = `Prom: ${finalTeam2.prom}`;

        document.getElementById('team-results').style.display = 'flex';
        document.getElementById('btn-share-teams').style.display = 'block';
    }

    function getImpactScore(p) { return (p.prom * 6) + (p.res * 3) + (p.tec * 2) - (p.edad * 0.5); }
    function calcularPromedioReal(equipo) { let sum = 0; equipo.forEach(p => sum += p.prom); return (sum / equipo.length).toFixed(1); }
    
    async function compartirEquipos() {
        const elemento = document.getElementById('team-capture-area');
        try {
            const canvas = await html2canvas(elemento, { backgroundColor: '#1a1a1a', scale: 2 });
            canvas.toBlob(async (blob) => {
                const file = new File([blob], "equipos.png", { type: "image/png" });
                if (navigator.canShare && navigator.canShare({ files: [file] })) {
                    await navigator.share({
                        files: [file],
                        title: 'Equipos del Martes',
                        text: 'Ac치 est치n los equipos!'
                    });
                } else {
                    alert("Tu navegador no soporta compartir im치genes directo.");
                }
            });
        } catch (err) {
            console.error(err);
            alert("Error al compartir: " + err);
        }
    }
</script>
