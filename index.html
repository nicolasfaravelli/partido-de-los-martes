<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <title>Partido de los Martes</title>
    <meta name="description" content="Plantel oficial">
    <meta property="og:title" content="Partido de los Martes">
    <meta property="og:description" content="Plantel Oficial">
    <meta property="og:type" content="website">

    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    
    <style>
        /* =========================================
           1. CONFIGURACI√ìN GLOBAL Y PALETA
           ========================================= */
        :root {
            --fondo-url: none;
            /* PALETA */
            --color-fondo: #0f0f0f;
            --color-paneles: #1a1a1a;
            --color-bordes: #333333;
            --color-texto: #ffffff;
            --color-acento: #d4af37; /* Dorado */
            --color-whatsapp: #25D366; 
            
            /* Colores Stats para promedios (C√≠rculos de color) */
            --stat-legend: #a855f7;
            --stat-gold: #d4af37;
            --stat-silver: #7a7a7a;
            --stat-bronze: #5e3e21;

            /* TIPOGRAF√çAS */
            --fuente-titulo: 'Bebas Neue', sans-serif;
            --fuente-texto: 'Roboto', system-ui, sans-serif;
        }

        body { 
            background-color: var(--color-fondo); 
            color: var(--color-texto); 
            font-family: var(--fuente-titulo); 
            margin: 0; padding: 0 20px 20px 20px; 
            background-image: var(--fondo-url); background-position: center; background-repeat: no-repeat; background-size: cover; background-attachment: fixed;
            transition: filter 0.3s;
        }

        /* =========================================
           2. ENCABEZADO
           ========================================= */
        .header-container { 
            text-align: center; position: sticky; top: 0; z-index: 100;
            margin: 0 -20px 10px -20px; padding: 20px 0 20px 0;
        }
        
        .header-container::before {
            content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; 
            background-color: var(--color-fondo); background-image: var(--fondo-url); 
            background-position: center; background-repeat: no-repeat; background-size: cover; background-attachment: fixed;
            opacity: 0.95; box-shadow: 0 10px 20px rgba(0,0,0,0.5); border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        h1 { margin: 0; letter-spacing: 2px; font-size: 2.5rem; color: var(--color-acento); }
        .title-img { max-width: 85%; height: auto; max-height: 120px; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.5)); transition: transform 0.1s; cursor: pointer; -webkit-tap-highlight-color: transparent; }
        .title-img:active { transform: scale(0.98); }

        /* =========================================
           3. BARRA DE CONTROLES
           ========================================= */
        .controls-area {
            max-width: 1200px; margin: 0 auto 20px auto; 
            display: flex; gap: 10px; flex-wrap: wrap;
            background: rgba(20, 20, 20, 0.95); padding: 15px; border-radius: 8px; border: 1px solid var(--color-bordes); 
            justify-content: space-between; align-items: center; position: relative; z-index: 50;
        }

        #search-input, #sort-select {
            flex: 1; padding: 10px 15px; font-family: var(--fuente-titulo); font-size: 1.1rem; letter-spacing: 1px;
            background: #2a2a2a; border: 1px solid #444; color: white; border-radius: 4px; min-width: 150px;
        }
        #search-input:focus, #sort-select:focus { outline: none; border-color: var(--color-acento); }

        .btn-standard {
            background: #333; color: white; border: 1px solid #555; padding: 10px 20px; border-radius: 4px; cursor: pointer;
            font-family: var(--fuente-titulo); font-size: 1.3rem; letter-spacing: 1px;
            display: flex; align-items: center; gap: 8px; justify-content: center; transition: all 0.2s;
        }
        .btn-standard:hover { background: #444; border-color: var(--color-acento); }

        /* Bot√≥n Leyenda (Dorado) */
        .btn-legend {
            background: var(--color-acento); color: #000; border: 1px solid var(--color-acento); font-weight: bold;
        }
        .btn-legend:hover { filter: brightness(1.1); }

        /* =========================================
           4. ESTRUCTURA DE LA CARTA (CONTENEDOR)
           ========================================= */
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 20px; max-width: 1200px; margin: 0 auto; padding-bottom: 50px; }
        
        .card { position: relative; width: 100%; aspect-ratio: 2 / 3; background: transparent; cursor: pointer; transition: transform 0.2s ease-out; container-type: size; transform: translateZ(0); -webkit-tap-highlight-color: transparent; }
        .card:hover { transform: scale(1.05); z-index: 10; }

        .card-bg-wrapper { position: absolute; top: 0; left: 0; width: 100%; height: 100%; overflow: hidden; display: block; filter: drop-shadow(0 5px 6px rgba(0,0,0,0.6)); z-index: 1; }
        .card-bg { width: 100%; height: 100%; object-fit: contain; display: block; image-rendering: auto; transform: translateZ(0); backface-visibility: hidden; will-change: transform; }
        
        /* FOTO DEL JUGADOR */
        .card-face { position: absolute; z-index: 2; top: 9.75%; left: 5.25%; width: 95%; object-fit: contain; display: block; }
        
        .info-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 3; pointer-events: none; }

        /* =================================================================
           4.1. CONFIGURACI√ìN EST√âTICA DE LA CARTA (POSICIONES Y TAMA√ëOS)
           ================================================================= */
        
        /* Valoraci√≥n General */
        .rating { 
            position: absolute; 
            top: 13.5%; 
            left: 6%; 
            font-size: 18cqw; 
            text-align: center; 
            width: 25%; 
            line-height: 0.8; 
        }
        
        /* Posici√≥n */
        .position { 
            position: absolute; 
            top: 24%; 
            left: 6%; 
            font-size: 10cqw; 
            text-align: center; 
            width: 25%; 
            line-height: 1; 
        }
        
        /* Nombre */
        .name { 
            position: absolute; 
            top: 64.25%; 
            left: 5%; 
            width: 90%; 
            text-align: center; 
            font-size: 14.5cqw; 
            text-transform: uppercase; 
            letter-spacing: 1px; 
        }
        
        /* Contenedor Stats */
        .stats-container { 
            display: flex; 
            justify-content: space-between; 
            position: absolute; 
            top: 81%; 
            left: 8%; 
            width: 84.1%; 
        }
        
        .stat-box { text-align: center; width: 16%; }
        .stat-val { font-size: 8.5cqw; display: block; }

        /* ================================================================= */
        
        /* BRILLO (SHINE) */
        .shine-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 4; pointer-events: none; overflow: hidden; -webkit-mask-size: contain; mask-size: contain; -webkit-mask-repeat: no-repeat; mask-repeat: no-repeat; -webkit-mask-position: center; mask-position: center; }
        .shine-layer::after { content: ""; position: absolute; top: 0; left: -100%; width: 50%; height: 100%; background: linear-gradient(to right, rgba(255,255,255,0) 0%, rgba(255,255,255,0.3) 50%, rgba(255,255,255,0) 100%); transform: skewX(-25deg); transition: none; }
        
        /* Brillo al pasar mouse */
        .card:hover .shine-layer::after { left: 150%; transition: left 0.6s; }

        /* ANIMACI√ìN BRILLO (IDA - LEYENDA) */
        @keyframes shine-sweep { 0% { left: -100%; } 100% { left: 150%; } }
        .card.trigger-shine .shine-layer::after { animation: shine-sweep 0.7s ease-out forwards; }

        /* ANIMACI√ìN BRILLO (VUELTA - ACTUAL) */
        @keyframes shine-sweep-reverse { 0% { left: 150%; } 100% { left: -100%; } }
        .card.trigger-shine-reverse .shine-layer::after { animation: shine-sweep-reverse 0.7s ease-out forwards; }

        /* =========================================
           5. M√öSICA
           ========================================= */
        .music-btn { position: fixed; bottom: 20px; right: 20px; z-index: 2000; width: 50px; height: 50px; background: rgba(0, 0, 0, 0.8); border: 2px solid #444; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.5); transition: all 0.2s; -webkit-tap-highlight-color: transparent; }
        .music-btn:hover { transform: scale(1.1); border-color: var(--color-acento); }
        .music-btn.playing { border-color: var(--color-acento); color: var(--color-acento); background: rgba(0,0,0,0.9); }

        /* =========================================
           6. MODALES
           ========================================= */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 3000; flex-direction: column; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        #modal-card-container { width: 340px; aspect-ratio: 2 / 3; margin-bottom: 20px; filter: drop-shadow(0 0 20px rgba(0,0,0,0.5)); }
        
        .btn-group { display: flex; gap: 15px; justify-content: center; width: 100%; flex-wrap: wrap; }
        .btn-action { background-color: var(--color-acento); color: #000; border: none; font-weight: bold; font-family: var(--fuente-titulo); letter-spacing: 1px; font-size: 1.3rem; }
        .btn-action:hover { opacity: 0.9; transform: scale(1.02); }
        .btn-share { background-color: var(--color-whatsapp); color: #fff; border: none; font-weight: bold; font-family: var(--fuente-titulo); letter-spacing: 1px; font-size: 1.3rem; }
        .btn-share:hover { opacity: 0.9; transform: scale(1.02); }

        /* =========================================
           7. ARMADOR DE EQUIPOS
           ========================================= */
        #team-modal-content { background: var(--color-paneles); padding: 20px; border-radius: 8px; border: 1px solid var(--color-bordes); width: 90%; max-width: 800px; max-height: 90vh; display: flex; flex-direction: column; }
        .team-title { text-align: center; color: var(--color-acento); margin-bottom: 5px; font-size: 2rem; }
        #team-counter { text-align: center; color: #888; font-size: 1.1rem; margin-bottom: 15px; border-bottom: 1px solid var(--color-bordes); padding-bottom: 10px; font-family: var(--fuente-texto); font-weight: bold; text-transform: uppercase; }
        .team-scroll { overflow-y: auto; flex: 1; margin-bottom: 15px; border: 1px solid var(--color-bordes); padding: 10px; background: #111; display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 8px; }
        
        .player-row { display: flex; align-items: center; gap: 12px; padding: 12px; background: #252525; border-radius: 4px; cursor: pointer; user-select: none; transition: opacity 0.2s; font-family: var(--fuente-texto); font-weight: bold; font-size: 1rem; }
        .player-row:hover { background: #333; }
        .player-row.disabled { opacity: 0.3; cursor: not-allowed; pointer-events: none; }
        .player-check { transform: scale(1.3); accent-color: var(--color-acento); cursor: pointer; }
        
        /* ESTILOS INVITADO */
        .guest-controls { background: #2a2a2a; padding: 10px; border-radius: 4px; margin-bottom: 10px; border: 1px solid #444; }
        .guest-row { display: flex; align-items: center; justify-content: space-between; gap: 10px; }
        .guest-input { background: #111; border: 1px solid #555; color: white; padding: 5px; border-radius: 4px; font-family: var(--fuente-texto); width: 80px; }
        .guest-input-name { flex: 1; background: #111; border: 1px solid #555; color: white; padding: 5px; border-radius: 4px; font-family: var(--fuente-texto); }

        .btn-generate-group { display: flex; gap: 10px; width: 100%; margin-bottom: 15px; }
        .btn-generate { flex: 1; background: #333; color: #888; font-size: 1.4rem; border: 1px solid #444; pointer-events: none; transition: all 0.3s; font-family: var(--fuente-titulo); letter-spacing: 2px; border-radius: 4px; padding: 10px; text-align: center;}
        .btn-generate.active { background: var(--color-acento); color: #000; border-color: var(--color-acento); pointer-events: auto; cursor: pointer; font-weight: bold; }
        .btn-generate.manual-active { background: #444; color: #fff; border-color: #666; pointer-events: auto; cursor: pointer; font-weight: bold; }
        .btn-generate.active:hover, .btn-generate.manual-active:hover { transform: scale(1.02); }
        
        #team-capture-area { background: var(--color-paneles); padding: 15px; border-radius: 8px; }
        .team-results { display: none; flex-direction: row; gap: 15px; margin-top: 5px; }
        .team-column { flex: 1; padding: 15px; border-radius: 8px; border: 2px solid var(--color-bordes); }
        .team-white { background: #f0f0f0; color: #111; border-color: #fff; }
        .team-black { background: #111; color: #fff; border-color: #333; }
        .team-header { font-size: 2rem; text-align: center; border-bottom: 2px solid; margin-bottom: 5px; font-weight: bold; letter-spacing: 1px; }
        .team-avg { text-align: center; font-size: 1rem; margin-bottom: 15px; opacity: 0.8; font-family: var(--fuente-texto); font-weight: bold; }
        .team-list-item { padding: 8px 0; border-bottom: 1px solid rgba(128,128,128,0.3); font-size: 1.1rem; font-family: var(--fuente-texto); font-weight: bold; display: flex; justify-content: space-between; align-items: center; cursor: default; }
        
        /* MODO MANUAL CLICKABLE */
        .manual-mode .team-list-item { cursor: pointer; transition: background 0.2s; padding-left: 5px; padding-right: 5px; border-radius: 4px; }
        .manual-mode .team-white .team-list-item:hover { background: #ddd; }
        .manual-mode .team-black .team-list-item:hover { background: #333; }

        #loader { text-align: center; color: #666; margin-top: 50px; font-family: sans-serif;}
        body.retro-mode { filter: sepia(0.4) contrast(1.2) brightness(0.9); }
    </style>
</head>
<body>

    <div class="header-container" id="header-area" ondblclick="activarModoRetro()" title="Doble click para Modo Retro">
        <h1 id="default-title">PARTIDO DE LOS MARTES</h1>
    </div>
    
    <div class="controls-area">
        <input type="text" id="search-input" placeholder="Buscar jugador...">
        <select id="sort-select">
            <option value="nombre-asc">Nombre: A - Z</option>
            <option value="nombre-desc">Nombre: Z - A</option>
            <option value="prom-desc">Valoraci√≥n: Mayor a Menor</option>
            <option value="prom-asc">Valoraci√≥n: Menor a Mayor</option>
        </select>
        <button class="btn-standard" onclick="abrirArmador()">
            ARMAR EQUIPOS
        </button>
    </div>

    <div id="loader">Cargando jugadores...</div>
    <div id="grid-container" class="grid"></div>

    <div class="music-btn" onclick="toggleMusic()" title="Activar/Desactivar M√∫sica">
        <span id="music-icon">üîà</span>
    </div>
    <audio id="audio-player" loop></audio>

    <div id="modal" class="modal-overlay">
        <div id="modal-card-container"></div>
        <div class="btn-group" id="modal-buttons">
            </div>
    </div>

    <div id="team-modal" class="modal-overlay">
        <div id="team-modal-content">
            <div class="team-title">SELECCIONAR JUGADORES</div>
            <div id="team-counter">Faltan 10 jugadores</div>
            
            <div class="team-scroll">
                <div class="guest-controls">
                    <div class="player-row" style="margin-bottom: 5px; background: transparent; padding: 0;">
                        <input type="checkbox" id="check-invitado" class="player-check" onchange="toggleGuest(this)">
                        <span style="color: var(--color-acento);">AGREGAR INVITADO</span>
                    </div>
                    <div id="guest-inputs" class="guest-row" style="display:none;">
                        <input type="text" id="guest-name" class="guest-input-name" placeholder="Nombre Invitado" value="Invitado">
                        <input type="number" id="guest-rating" class="guest-input" placeholder="Media (0-99)" value="60" min="0" max="99" onchange="actualizarInvitado()">
                    </div>
                </div>
                
                <div id="players-checklist"></div>
            </div>
            
            <div class="btn-generate-group">
                <button class="btn-generate" onclick="generarEquipos()" id="btn-generate">
                    GENERAR AUTOM√ÅTICO
                </button>
                <button class="btn-generate manual-active" onclick="iniciarModoManual()" id="btn-manual" style="display:none;">
                    ARMAR MANUAL
                </button>
            </div>
            
            <div id="team-capture-area">
                <div id="team-results" class="team-results">
                    <div class="team-column team-white" id="col-team-1">
                        <div class="team-header">CLARO</div>
                        <div class="team-avg" id="avg-team-1">Prom: 0</div>
                        <div id="list-team-1"></div>
                    </div>
                    <div class="team-column team-black" id="col-team-2">
                        <div class="team-header">OSCURO</div>
                        <div class="team-avg" id="avg-team-2">Prom: 0</div>
                        <div id="list-team-2"></div>
                    </div>
                </div>
            </div>

            <div class="btn-group" style="margin-top: 15px;">
                <button class="btn-standard" onclick="cerrarArmador()">CERRAR</button>
                <button class="btn-standard btn-action" onclick="compartirEquipos()" id="btn-share-teams" style="display:none;">COMPARTIR</button>
            </div>
        </div>
    </div>

<script>
    // ====================================================================
    //   1. ZONA DE CONFIGURACI√ìN GENERAL (URLS Y RECURSOS)
    // ====================================================================
    
    const FONDO_URL = "https://raw.githubusercontent.com/nicolasfaravelli/partido-de-los-martes/main/Fondo.png"; 
    const TITULO_IMG_URL = "https://raw.githubusercontent.com/nicolasfaravelli/partido-de-los-martes/main/Titulo.png";
    const MUSICA_URL = "https://raw.githubusercontent.com/nicolasfaravelli/partido-de-los-martes/main/Musica.mp3";
    const LEYENDA_FONDO_URL = "https://raw.githubusercontent.com/nicolasfaravelli/partido-de-los-martes/main/LEYENDA.png";

    // 1.1. URL MODIFICADA CON CACHE BUSTER (Date.now())
    const BASE_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTHOyW-OmPwPBpIwBw30sBjYdcLn1_8xFjkXfG9_tLFeB960jfYnnouTDieGPeKSK49FYM1tSGng_mg/pub?gid=1826229647&single=true&output=csv";
    const NEW_CSV_URL = BASE_CSV_URL + "&uid=" + Date.now(); // Forzar URL √∫nica
    const PROXY_URL = "https://corsproxy.io/?" + encodeURIComponent(NEW_CSV_URL);

    // ====================================================================
    //   1.2. CONFIGURACI√ìN DE COLORES
    // ====================================================================
    const COLORES = { 
        'leyenda': '#644b14', 
        'legendario': '#372864',
        'oro': '#624f21', 
        'plata': '#434343', 
        'bronce': '#5e3e21'
    };

    // ====================================================================
    //   1.3. CONFIGURACI√ìN MATEM√ÅTICA LEYENDA (EDITAR AQU√ç LOS VALORES)
    // ====================================================================
    
    // Multiplicadores seg√∫n el orden de sus stats (Del mejor al peor)
    const MULTIPLICADORES_RANKING = [1.125, 1.1, 1.075, 1.05, 1.025, 1]; 

    // Bonus extra acumulativo para stats f√≠sicos (se aplica DESPU√âS del ranking)
    const BONUS_FISICO = { 
        'res': 1.05, // Resistencia extra
        'vel': 1.025  // Velocidad extra
    };

    const TOPE_MAXIMO = 98; // Ning√∫n stat superar√° este valor

    // ====================================================================
    //   2. L√ìGICA DEL SISTEMA
    // ====================================================================

    document.addEventListener("DOMContentLoaded", function() {
        if(FONDO_URL) document.documentElement.style.setProperty('--fondo-url', `url('${FONDO_URL}')`);
        if(TITULO_IMG_URL) {
            const header = document.getElementById('header-area');
            if(header) header.innerHTML = `<img src="${TITULO_IMG_URL}" class="title-img" alt="Logo">`;
        }
        if(MUSICA_URL) {
            const player = document.getElementById('audio-player');
            if(player) player.src = MUSICA_URL;
        } else {
            const btn = document.querySelector('.music-btn');
            if(btn) btn.style.display = 'none';
        }
    });

    let datosOriginales = []; 
    let datosFiltrados = [];  

    // CARGA DE DATOS
    Papa.parse(PROXY_URL, {
        download: true, header: false, skipEmptyLines: true,
        complete: function(results) {
            const data = results.data;
            const loader = document.getElementById('loader');
            if(loader) loader.style.display = 'none';
            if(data.length > 0) data.shift(); 

            datosOriginales = data.map((fila, index) => {
                const nombre = fila[0]; 
                if(!nombre || nombre === 'Jugador') return null;
                
                let tipoCarta = fila[10] ? fila[10].trim().toLowerCase() : 'oro';
                let colorTexto = COLORES[tipoCarta] || '#624f21'; 

                return {
                    id: index,
                    nombre: nombre,
                    edad: parseInt(fila[1]) || 25, 
                    ata: parseInt(fila[2]) || 0, def: parseInt(fila[3]) || 0, tec: parseInt(fila[4]) || 0, 
                    vel: parseInt(fila[5]) || 0, res: parseInt(fila[6]) || 0, arq: parseInt(fila[7]) || 0,
                    prom: parseInt(fila[8]) || 0, pos: fila[9] ? fila[9].trim() : "",
                    fondo: fila[11] ? fila[11].trim() : "", foto: fila[12] ? fila[12].trim() : "",
                    fotoLeyenda: fila[13] ? fila[13].trim() : "", 
                    color: colorTexto,
                    tipoBase: tipoCarta
                };
            }).filter(item => item !== null); 

            datosFiltrados = [...datosOriginales];
            aplicarFiltrosYOrden();
        }
    });

    // FILTROS
    const searchInput = document.getElementById('search-input');
    const sortSelect = document.getElementById('sort-select');
    if(searchInput) searchInput.addEventListener('input', aplicarFiltrosYOrden);
    if(sortSelect) sortSelect.addEventListener('change', aplicarFiltrosYOrden);
    
    function aplicarFiltrosYOrden() {
        if(!searchInput || !sortSelect) return;
        const textoBusqueda = searchInput.value.toLowerCase();
        const criterioFull = sortSelect.value.split('-'); 
        const criterio = criterioFull[0];
        const orden = criterioFull[1];

        datosFiltrados = datosOriginales.filter(j => j.nombre.toLowerCase().includes(textoBusqueda));

        datosFiltrados.sort((a, b) => {
            if (criterio === 'nombre' || criterio === 'pos') return orden === 'asc' ? a[criterio].localeCompare(b[criterio]) : b[criterio].localeCompare(a[criterio]);
            return orden === 'asc' ? a[criterio] - b[criterio] : b[criterio] - a[criterio];
        });
        renderizarGrilla(datosFiltrados);
    }

    function renderizarGrilla(lista) {
        const container = document.getElementById('grid-container');
        if(!container) return;
        container.innerHTML = '';
        if(lista.length === 0) { container.innerHTML = '<p style="text-align:center; width:100%; color:#aaa;">No se encontraron jugadores.</p>'; return; }
        lista.forEach(jugadorObj => {
            const html = `<div class="card" onclick="abrirModalPorID(${jugadorObj.id})">${generarHTMLCarta(jugadorObj, true)}</div>`;
            container.innerHTML += html;
        });
    }

    function generarHTMLCarta(j, lazy = false) {
        const loadingAttr = lazy ? 'loading="lazy"' : '';
        const fotoHtml = j.foto ? `<img src="${j.foto}" class="card-face" ${loadingAttr} crossorigin="anonymous">` : '';
        return `
            <div class="card-bg-wrapper"><img src="${j.fondo}" class="card-bg" ${loadingAttr} referrerpolicy="no-referrer" crossorigin="anonymous"></div>
            <div class="shine-layer" style="-webkit-mask-image: url('${j.fondo}'); mask-image: url('${j.fondo}');"></div>
            ${fotoHtml}
            <div class="info-layer">
                <div class="rating" style="color: ${j.color}">${j.prom}</div>
                <div class="position" style="color: ${j.color}">${j.pos}</div>
                <div class="name" style="color: ${j.color}">${j.nombre}</div>
                <div class="stats-container" style="color: ${j.color}">
                    <div class="stat-box"><span class="stat-val">${j.ata}</span></div>
                    <div class="stat-box"><span class="stat-val">${j.def}</span></div>
                    <div class="stat-box"><span class="stat-val">${j.tec}</span></div>
                    <div class="stat-box"><span class="stat-val">${j.vel}</span></div>
                    <div class="stat-box"><span class="stat-val">${j.res}</span></div>
                    <div class="stat-box"><span class="stat-val">${j.arq}</span></div>
                </div>
            </div>
        `;
    }

    // ====================================================================
    //   3. MODAL, LEYENDA Y L√ìGICA DE MULTIPLICADORES
    // ====================================================================
    let jugadorActualEnModal = null;
    let esModoLeyenda = false;

    function abrirModalPorID(idReal) {
        const jugador = datosOriginales.find(j => j.id === idReal);
        if(!jugador) return;
        
        jugadorActualEnModal = jugador;
        esModoLeyenda = false; 
        renderizarModal(jugador);
        const modal = document.getElementById('modal');
        if(modal) modal.style.display = 'flex';
    }

    function renderizarModal(j) {
        const modalContainer = document.getElementById('modal-card-container');
        const modalButtons = document.getElementById('modal-buttons');
        if(!modalContainer || !modalButtons) return;

        modalContainer.innerHTML = `<div class="card" id="carta-para-descargar">${generarHTMLCarta(j, false)}</div>`;
        
        // 2. L√ìGICA DE BOTONES REORGANIZADA
        let botonesHTML = '';
        
        // BOTON LEYENDA (IZQUIERDA) - SOLO SI EXISTE LA FOTO
        if (jugadorActualEnModal.fotoLeyenda) {
            if (esModoLeyenda) {
                botonesHTML += `<button class="btn-standard" onclick="toggleLeyenda()">ACTUAL</button>`;
            } else {
                botonesHTML += `<button class="btn-standard btn-legend" onclick="toggleLeyenda()">LEYENDA</button>`;
            }
        }

        // BOTON DESCARGAR (CENTRO)
        botonesHTML += `<button class="btn-standard btn-action" onclick="descargarCarta()">DESCARGAR</button>`;
        
        // BOTON CERRAR (DERECHA)
        botonesHTML += `<button class="btn-standard" onclick="cerrarModal()">CERRAR</button>`;

        modalButtons.innerHTML = botonesHTML;
    }

    // --- C√ÅLCULO DE STATS LEYENDA (NUEVA L√ìGICA) ---
    function calcularObjetoLeyenda(base) {
        // 1. Extraemos los stats en un array para poder ordenarlos
        let statsArray = [
            { id: 'ata', valor: base.ata },
            { id: 'def', valor: base.def },
            { id: 'tec', valor: base.tec },
            { id: 'vel', valor: base.vel },
            { id: 'res', valor: base.res },
            { id: 'arq', valor: base.arq }
        ];

        // 2. Ordenamos de MAYOR A MENOR valor
        statsArray.sort((a, b) => b.valor - a.valor);

        // 3. Objeto temporal para guardar los nuevos valores
        let nuevosValores = {};

        // 4. Aplicamos multiplicadores seg√∫n posici√≥n en el ranking
        statsArray.forEach((statObj, index) => {
            // Obtenemos el multiplicador correspondiente a su posici√≥n (0 es el 1¬∫)
            let multiplicador = MULTIPLICADORES_RANKING[index] || 1.05;
            
            let valorCalculado = statObj.valor * multiplicador;

            // 5. Aplicamos Bonus F√≠sico (si corresponde)
            if (BONUS_FISICO[statObj.id]) {
                valorCalculado = valorCalculado * BONUS_FISICO[statObj.id];
            }

            // 6. Aplicamos Redondeo y Tope
            nuevosValores[statObj.id] = Math.min(TOPE_MAXIMO, Math.round(valorCalculado));
        });

        // 7. Calculamos el nuevo promedio (Suma de los 6 nuevos stats dividido 6)
        let suma = 0;
        for (let key in nuevosValores) {
            suma += nuevosValores[key];
        }
        let nuevoPromedio = Math.min(99, Math.round(suma / 6));

        // 8. Retornamos el objeto completo con los cambios
        return {
            ...base,
            foto: base.fotoLeyenda,
            fondo: LEYENDA_FONDO_URL,
            color: COLORES['leyenda'], // Color espec√≠fico
            ata: nuevosValores.ata,
            def: nuevosValores.def,
            tec: nuevosValores.tec,
            vel: nuevosValores.vel,
            res: nuevosValores.res,
            arq: nuevosValores.arq,
            prom: nuevoPromedio
        };
    }

    function toggleLeyenda() {
        esModoLeyenda = !esModoLeyenda;
        let jugadorParaMostrar;

        if (esModoLeyenda) {
            jugadorParaMostrar = calcularObjetoLeyenda(jugadorActualEnModal);
        } else {
            jugadorParaMostrar = jugadorActualEnModal;
        }
        
        renderizarModal(jugadorParaMostrar);
        
        // EFECTO DE TRANSICI√ìN: DISPARAR BRILLO (IDA O VUELTA)
        const cardElement = document.getElementById('carta-para-descargar');
        if(cardElement) {
            // Limpiamos ambas clases primero
            cardElement.classList.remove('trigger-shine'); 
            cardElement.classList.remove('trigger-shine-reverse'); 
            
            void cardElement.offsetWidth; // Force Reflow
            
            // Si vamos a Leyenda -> Brillo normal (Ida)
            // Si volvemos a Actual -> Brillo invertido (Vuelta)
            if (esModoLeyenda) {
                cardElement.classList.add('trigger-shine'); 
            } else {
                cardElement.classList.add('trigger-shine-reverse');
            }
        }
    }

    function cerrarModal() { 
        const m = document.getElementById('modal');
        if(m) m.style.display = 'none'; 
    }
    
    function descargarCarta() {
        const elemento = document.getElementById('carta-para-descargar');
        const btn = document.querySelector('.btn-action');
        if(btn) btn.innerText = "PROCESANDO...";
        const shine = elemento.querySelector('.shine-layer');
        if(shine) shine.style.display = 'none';
        html2canvas(elemento, { useCORS: true, allowTaint: true, backgroundColor: null, scale: 3 }).then(canvas => {
            const link = document.createElement('a'); link.download = `FUT_Carta_${Date.now()}.png`; link.href = canvas.toDataURL("image/png"); link.click();
            if(btn) btn.innerText = "DESCARGAR"; 
            if(shine) shine.style.display = 'block';
        }).catch(err => { 
            alert("Error: " + err); 
            if(btn) btn.innerText = "ERROR"; 
            if(shine) shine.style.display = 'block'; 
        });
    }
    
    document.addEventListener('keydown', function(event) { if (event.key === "Escape") { cerrarModal(); cerrarArmador(); } });

    // =========================================
    //   4. AUDIO Y EXTRAS
    // =========================================
    const audioPlayer = document.getElementById('audio-player');
    const musicBtn = document.querySelector('.music-btn');
    const musicIcon = document.getElementById('music-icon');
    let isPlaying = false;
    
    function toggleMusic() {
        if(!audioPlayer || !audioPlayer.src) return; 
        if (isPlaying) { 
            audioPlayer.pause(); 
            if(musicIcon) musicIcon.innerText = "üîà"; 
            if(musicBtn) musicBtn.classList.remove('playing'); 
            isPlaying = false; 
        } else { 
            audioPlayer.volume = 0.3; 
            audioPlayer.play().then(() => { 
                if(musicIcon) musicIcon.innerText = "üîä"; 
                if(musicBtn) musicBtn.classList.add('playing'); 
                isPlaying = true; 
            }).catch(e => console.log("Bloqueo audio", e)); 
        }
    }
    function activarModoRetro() { document.body.classList.toggle('retro-mode'); }

    // =========================================
    //   5. ARMADOR DE EQUIPOS 
    // =========================================
    let guestActive = false;
    let manualMode = false;
    let manualTeamA = [];
    let manualTeamB = [];

    function abrirArmador() {
        const list = document.getElementById('players-checklist');
        if(!list) return;
        list.innerHTML = '';
        const sorted = [...datosOriginales].sort((a,b) => a.nombre.localeCompare(b.nombre));
        
        sorted.forEach(j => {
            list.innerHTML += `
            <label class="player-row" id="row-${j.id}">
                <input type="checkbox" class="player-check" value="${j.id}" onclick="controlarLimite(this)">
                <span>${j.nombre}</span>
            </label>`;
        });
        
        const res = document.getElementById('team-results');
        const share = document.getElementById('btn-share-teams');
        const modal = document.getElementById('team-modal');
        const btnManual = document.getElementById('btn-manual');
        
        if(res) res.style.display = 'none';
        if(share) share.style.display = 'none';
        if(btnManual) btnManual.style.display = 'none'; // Ocultar manual al inicio
        if(modal) modal.style.display = 'flex';
        
        // Reset state
        document.getElementById('check-invitado').checked = false;
        document.getElementById('check-invitado').disabled = false;
        toggleGuest(document.getElementById('check-invitado'));
        
        actualizarContador(0);
    }

    function cerrarArmador() { 
        const m = document.getElementById('team-modal');
        if(m) m.style.display = 'none'; 
        // Quitar clase manual para limpiar hover
        document.getElementById('team-results').classList.remove('manual-mode');
    }

    function toggleGuest(checkbox) {
        guestActive = checkbox.checked;
        const inputs = document.getElementById('guest-inputs');
        if(inputs) inputs.style.display = guestActive ? 'flex' : 'none';
        controlarLimite(checkbox);
    }

    function controlarLimite(checkbox) {
        const checkedPlayers = document.querySelectorAll('.player-check:not(#check-invitado):checked');
        const isGuest = document.getElementById('check-invitado').checked;
        
        let count = checkedPlayers.length;
        if(isGuest) count++;

        const btn = document.getElementById('btn-generate');
        if(btn) btn.innerText = "GENERAR AUTOM√ÅTICO";
        
        const res = document.getElementById('team-results');
        if(res) res.style.display = 'none'; // Ocultar resultados si se toca algo

        actualizarContador(count);
        
        if (count >= 10) {
            document.querySelectorAll('.player-check:not(:checked)').forEach(cb => {
                cb.disabled = true; 
                const row = document.getElementById(`row-${cb.value}`);
                if(row) row.classList.add('disabled');
            });
            // Si el invitado no est√° checkeado, deshabilitarlo tambi√©n
            if(!isGuest) document.getElementById('check-invitado').disabled = true;
        } else {
            document.querySelectorAll('.player-check').forEach(cb => {
                cb.disabled = false; 
                const row = document.getElementById(`row-${cb.value}`);
                if(row) row.classList.remove('disabled');
            });
             document.getElementById('check-invitado').disabled = false;
        }
    }

    function actualizarContador(count) {
        const missing = 10 - count;
        const counterLabel = document.getElementById('team-counter');
        const generateBtn = document.getElementById('btn-generate');
        const manualBtn = document.getElementById('btn-manual');
        
        if(!counterLabel || !generateBtn) return;
        
        if (missing > 0) {
            counterLabel.innerText = `FALTAN ${missing} JUGADORES`; counterLabel.style.color = "#888"; 
            generateBtn.classList.remove('active');
            if(manualBtn) manualBtn.style.display = 'none';
        } else if (missing === 0) {
            counterLabel.innerText = "¬°LISTO! (10/10)"; counterLabel.style.color = "var(--color-acento)"; 
            generateBtn.classList.add('active');
            if(manualBtn) manualBtn.style.display = 'block'; // Mostrar bot√≥n manual
        } else {
            counterLabel.innerText = "DEMASIADOS JUGADORES";
        }
    }

    // COLOR POR PROMEDIO (Para la lista de equipos)
    function getRatingColor(val) {
        if (val >= 90) return 'var(--stat-legend)'; 
        if (val >= 80) return 'var(--stat-gold)';
        if (val >= 70) return 'var(--stat-silver)'; 
        return 'var(--stat-bronze)';
    }

    function getPlayerHTML(p, isWhite, isManual = false) {
        const colorNota = getRatingColor(p.prom);
        const emoji = isWhite ? '‚ñ´Ô∏è' : '‚ñ™Ô∏è';
        let onClickAttr = "";
        let helpText = "";
        
        if(isManual) {
            onClickAttr = `onclick="cambiarEquipoManual(${p.id})"`;
            helpText = " <small style='opacity:0.5; font-size:0.8em'>‚Üî</small>";
        }

        return `
        <div class="team-list-item" ${onClickAttr} title="${isManual ? 'Toca para cambiar de equipo' : ''}">
            <span>${emoji} ${p.nombre} ${helpText}</span>
            <strong style="color:${colorNota}">${p.prom}</strong>
        </div>`;
    }

    function getGuestData() {
        const name = document.getElementById('guest-name').value || "Invitado";
        const rat = parseInt(document.getElementById('guest-rating').value) || 60;
        return {
            id: 99999, // ID Ficticio alto
            nombre: name,
            prom: rat,
            ata: rat, def: rat, tec: rat, vel: rat, res: rat, arq: 50, edad: 25,
            isGuest: true
        };
    }
    
    function actualizarInvitado() {
        // Si estamos en modo manual y cambiamos el rating, actualizar
        if(manualMode) {
             const guest = getGuestData();
             // Buscar en las listas manuales y actualizar
             let foundIndexA = manualTeamA.findIndex(p => p.id === 99999);
             if(foundIndexA !== -1) manualTeamA[foundIndexA] = guest;
             
             let foundIndexB = manualTeamB.findIndex(p => p.id === 99999);
             if(foundIndexB !== -1) manualTeamB[foundIndexB] = guest;
             
             renderizarEquiposManuales();
        }
    }

    function generarEquipos() {
        manualMode = false;
        document.getElementById('team-results').classList.remove('manual-mode');
        
        const checkboxes = document.querySelectorAll('.player-check:not(#check-invitado):checked');
        const selectedIds = Array.from(checkboxes).map(cb => parseInt(cb.value));
        
        let pool = datosOriginales.filter(j => selectedIds.includes(j.id));
        
        if(guestActive) {
            pool.push(getGuestData());
        }
        
        const btn = document.getElementById('btn-generate');
        if(btn) btn.innerText = "REGENERAR AUTOM√ÅTICO";

        let teamA = []; let teamB = []; let scoreA = 0; let scoreB = 0;

        pool.sort((a, b) => b.arq - a.arq);
        // Porteros (simple logic, los 2 con mas ARQ van al arco)
        // Nota: Si el invitado es arquero, puede romper esto un poco, pero asumo invitado de campo.
        let portero1 = pool[0];
        let portero2 = pool[1];
        let resto = pool.slice(2);

        teamA.push(portero1); scoreA += getImpactScore(portero1);
        teamB.push(portero2); scoreB += getImpactScore(portero2);

        resto.sort((a, b) => {
            let impactA = getImpactScore(a) + (Math.random() * 4 - 2); 
            let impactB = getImpactScore(b) + (Math.random() * 4 - 2);
            return impactB - impactA;
        });

        resto.forEach(p => {
            let impact = getImpactScore(p);
            if (scoreA <= scoreB) { teamA.push(p); scoreA += impact; } 
            else { teamB.push(p); scoreB += impact; }
        });

        let finalTeam1, finalTeam2;
        if (Math.random() > 0.5) {
            finalTeam1 = { data: teamA, prom: calcularPromedioReal(teamA) };
            finalTeam2 = { data: teamB, prom: calcularPromedioReal(teamB) };
        } else {
            finalTeam1 = { data: teamB, prom: calcularPromedioReal(teamB) };
            finalTeam2 = { data: teamA, prom: calcularPromedioReal(teamA) };
        }

        finalTeam1.data.sort((a,b) => a.nombre.localeCompare(b.nombre));
        finalTeam2.data.sort((a,b) => a.nombre.localeCompare(b.nombre));

        renderizarResultados(finalTeam1.data, finalTeam2.data, finalTeam1.prom, finalTeam2.prom);
    }
    
    // =========================================
    //   5.1 L√ìGICA MANUAL
    // =========================================
    function iniciarModoManual() {
        manualMode = true;
        document.getElementById('team-results').classList.add('manual-mode');
        
        const checkboxes = document.querySelectorAll('.player-check:not(#check-invitado):checked');
        const selectedIds = Array.from(checkboxes).map(cb => parseInt(cb.value));
        
        let pool = datosOriginales.filter(j => selectedIds.includes(j.id));
        if(guestActive) {
            pool.push(getGuestData());
        }
        
        // Ordenar alfab√©ticamente para facilitar la busqueda visual
        pool.sort((a,b) => a.nombre.localeCompare(b.nombre));
        
        // Repartir 5 y 5 arbitrariamente para empezar
        manualTeamA = pool.slice(0, 5);
        manualTeamB = pool.slice(5, 10);
        
        renderizarEquiposManuales();
        
        const res = document.getElementById('team-results');
        const share = document.getElementById('btn-share-teams');
        if(res) res.style.display = 'flex';
        if(share) share.style.display = 'block';
    }
    
    function renderizarEquiposManuales() {
        // Recalcular promedios
        const promA = calcularPromedioReal(manualTeamA);
        const promB = calcularPromedioReal(manualTeamB);
        
        // Renderizar con flag isManual = true
        const list1 = document.getElementById('list-team-1');
        const list2 = document.getElementById('list-team-2');
        const avg1 = document.getElementById('avg-team-1');
        const avg2 = document.getElementById('avg-team-2');
        
        manualTeamA.sort((a,b) => a.nombre.localeCompare(b.nombre));
        manualTeamB.sort((a,b) => a.nombre.localeCompare(b.nombre));

        if(list1) list1.innerHTML = manualTeamA.map(p => getPlayerHTML(p, true, true)).join('');
        if(avg1) avg1.innerText = `Prom: ${promA}`;

        if(list2) list2.innerHTML = manualTeamB.map(p => getPlayerHTML(p, false, true)).join('');
        if(avg2) avg2.innerText = `Prom: ${promB}`;
    }
    
    function cambiarEquipoManual(idJugador) {
        // Buscar d√≥nde est√°
        let indexA = manualTeamA.findIndex(p => p.id === idJugador);
        
        if (indexA !== -1) {
            // Est√° en el A, mover al B
            const player = manualTeamA.splice(indexA, 1)[0];
            manualTeamB.push(player);
        } else {
            // Debe estar en el B
            let indexB = manualTeamB.findIndex(p => p.id === idJugador);
            if (indexB !== -1) {
                const player = manualTeamB.splice(indexB, 1)[0];
                manualTeamA.push(player);
            }
        }
        renderizarEquiposManuales();
    }

    function renderizarResultados(t1Data, t2Data, p1, p2) {
        const list1 = document.getElementById('list-team-1');
        const list2 = document.getElementById('list-team-2');
        const avg1 = document.getElementById('avg-team-1');
        const avg2 = document.getElementById('avg-team-2');
        
        if(list1) list1.innerHTML = t1Data.map(p => getPlayerHTML(p, true)).join('');
        if(avg1) avg1.innerText = `Prom: ${p1}`;

        if(list2) list2.innerHTML = t2Data.map(p => getPlayerHTML(p, false)).join('');
        if(avg2) avg2.innerText = `Prom: ${p2}`;

        const res = document.getElementById('team-results');
        const share = document.getElementById('btn-share-teams');
        if(res) res.style.display = 'flex';
        if(share) share.style.display = 'block';
    }

    function getImpactScore(p) { return (p.prom * 6) + (p.res * 3) + (p.tec * 2) - (p.edad * 0.5); }
    function calcularPromedioReal(equipo) { 
        if(equipo.length === 0) return 0;
        let sum = 0; equipo.forEach(p => sum += p.prom); return (sum / equipo.length).toFixed(1); 
    }
    
    async function compartirEquipos() {
        const elemento = document.getElementById('team-capture-area');
        try {
            const canvas = await html2canvas(elemento, { backgroundColor: '#1a1a1a', scale: 2 });
            canvas.toBlob(async (blob) => {
                const file = new File([blob], "equipos.png", { type: "image/png" });
                if (navigator.canShare && navigator.canShare({ files: [file] })) {
                    await navigator.share({
                        files: [file],
                        title: 'Equipos del Martes',
                        text: 'Ac√° est√°n los equipos!'
                    });
                } else {
                    alert("Tu navegador no soporta compartir im√°genes directo.");
                }
            });
        } catch (err) {
            console.error(err);
            alert("Error al compartir: " + err);
        }
    }
</script>

</body>
</html>
