<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Partido de los Martes</title>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* ==========================================
            1. VARIABLES Y CONFIGURACIÃ“N BASE
            ========================================== */
        :root {
            --color-acento: #75AADB; 
            --color-acento-off: #3d4e5f;          
            --color-fondo: #0f0f0f; 
            --color-paneles: #1a1a1a; 
            --color-bordes: #333333;
            --fuente-impacto: 'Bebas Neue', sans-serif;
            --fuente-datos: 'Montserrat', sans-serif;
            --url-pizarra: url('https://raw.githubusercontent.com/nicolasfaravelli/partido-de-los-martes/main/Fondo%20armador.png');
            --blur-header: blur(15px);
            --velocidad-brillo: 1s; 
            --velocidad-botones: 0.1s;
            --resplandor-duracion: 0.4s;}
        body { 
            background-color: var(--color-fondo); 
            color: #fff; 
            font-family: var(--fuente-datos); 
            margin: 0; 
            padding: 0 20px 20px 20px; 
            background-image: var(--fondo-url); 
            background-position: center; 
            background-repeat: no-repeat; 
            background-size: cover; 
            background-attachment: fixed; 
            user-select: none;}
        body.modal-open { overflow: hidden;}
        #version-tag { position: fixed; bottom: 10px; left: 15px; font-size: 0.7rem; color: #444; z-index: 5000; font-weight: bold;}
        /* ==========================================
            2. ENCABEZADO TRASLÃšCIDO (STUCK)
            ========================================== */
        .main-sticky-header {
            position: sticky;
            top: 0;
            z-index: 2000;
            margin: 0 -20px 30px -20px;
            padding: 0 20px 20px 20px;
            background: rgba(15, 15, 15, 0.85);
            backdrop-filter: var(--blur-header);
            -webkit-backdrop-filter: var(--blur-header);
            border-bottom: 2px solid var(--color-acento);
            box-shadow: 0 10px 30px rgba(0,0,0,0.8);}
        .header-container { text-align: center; padding: 15px 0 10px 0;}
        .title-img { max-width: 80%; height: auto; max-height: 100px; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.5));}
        /* CONTROLES HOMOGÃ‰NEOS */
        .controls-area { 
            max-width: 1100px; 
            margin: 0 auto; 
            display: flex; 
            gap: 12px; 
            flex-wrap: wrap; 
            justify-content: center; 
            align-items: center;}
        #search-input, #sort-select, .controls-area .btn { 
            height: 50px; 
            box-sizing: border-box; 
            border-radius: 6px; 
            font-family: var(--fuente-datos); 
            font-weight: 700; 
            font-size: 0.85rem; 
            text-transform: uppercase; 
            letter-spacing: 0.5px;
            border: 1px solid var(--color-bordes);
            transition: all 0.2s ease;}
        #search-input, #sort-select { 
            flex: 1; 
            padding: 0 15px; 
            background: rgba(42, 42, 42, 0.9); 
            color: white; 
            min-width: 180px; 
            outline: none;}
        #search-input:focus, #sort-select:focus { 
            border-color: var(--color-acento); 
            background: #333;}
        .controls-area .btn {
            padding: 0 30px;
            background: var(--color-acento);
            color: #fff;
            cursor: pointer;
            border: none;
            min-width: 220px;
            display: flex;
            justify-content: center;
            align-items: center;}
        .controls-area .btn:hover { 
            background: #8bb7e2; 
            box-shadow: 0 0 20px rgba(117, 170, 219, 0.4); 
            transform: translateY(-1px);}
        /* ==========================================
            3. GRID Y CARTAS
            ========================================== */
        .grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(170px, 1fr)); 
            gap: 25px; 
            max-width: 1200px; 
            margin: 0 auto; 
            padding-bottom: 50px;}
        .card { position: relative; width: 100%; aspect-ratio: 2 / 3; cursor: pointer; transition: transform 0.2s; container-type: size; outline: none; -webkit-tap-highlight-color: transparent;}
        .card:hover { transform: scale(1.05); z-index: 10;}
        .card-bg-wrapper { 
            position: absolute; 
            top: 0; left: 0; width: 100%; height: 100%; 
            overflow: hidden; 
            filter: drop-shadow(0 8px 12px rgba(0,0,0,0.7));}
        .card-bg { width: 100%; height: 100%; object-fit: contain;}
        .card-face { position: absolute; z-index: 2; top: 9.75%; left: 5.25%; width: 95%; object-fit: contain;}
        .info-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 3; pointer-events: none;}
        .rating { font-family: var(--fuente-impacto); position: absolute; top: 13.5%; left: 6%; font-size: 18cqw; text-align: center; width: 25%; line-height: 0.8;}
        .position { font-family: var(--fuente-impacto); position: absolute; top: 24%; left: 6%; font-size: 10cqw; text-align: center; width: 25%;}
        .name { font-family: var(--fuente-impacto); position: absolute; top: 64.25%; left: 5%; width: 90%; text-align: center; font-size: 14.5cqw; text-transform: uppercase;}
        .stats-container { display: flex; justify-content: space-between; position: absolute; top: 81%; left: 8%; width: 84.1%;}
        .stat-val { font-family: var(--fuente-impacto); font-size: 8.5cqw; display: block; text-align: center; width: 16%;}
        /* SHINE EFFECT (SOLO HOVER) */
        .shine-layer::after {
            content: "";
            position: absolute;
            top: 0; left: 0; width: 300%; height: 300%; 
            background: linear-gradient(135deg, rgba(255,255,255,0) 45%, rgba(255,255,255,0.8) 50%, rgba(255,255,255,0) 55%);
            pointer-events: none; opacity: 0; z-index: 6; transform: translate(-100%, -100%);}
        .card:hover .shine-layer::after { 
            animation: brillo-diagonal-ida var(--velocidad-brillo) ease-in-out forwards;}
        @keyframes brillo-diagonal-ida { 0% { transform: translate(-100%, -100%); opacity: 1; } 100% { transform: translate(100%, 100%); opacity: 1; }}
        @keyframes flash-blanco {
            0% { filter: brightness(1) contrast(1) saturate(1) drop-shadow(0 0 0 rgba(255,255,255,0)); }
            50% { filter: brightness(2) contrast(0.5) saturate(0.5) drop-shadow(0 0 50px rgba(255,255,255,0.25)); }
            100% { filter: brightness(1) contrast(1) saturate(1) drop-shadow(0 0 0 rgba(255,255,255,0)); }}
        @keyframes flash-jugador {
            0% { filter: brightness(1) contrast(1) saturate(1) drop-shadow(0 0 0 rgba(255,255,255,0)); }
            50% { filter: brightness(4) contrast(0) saturate(0) drop-shadow(0 0 25px rgba(255,255,255,0.25)); }
            100% { filter: brightness(1) contrast(1) saturate(1) drop-shadow(0 0 0 rgba(255,255,255,0)); }}

        .flash-evolucion { animation: flash-blanco var(--resplandor-duracion) ease-out; }
        .flash-foto { animation: flash-jugador var(--resplandor-duracion) ease-out; }
        /* ==========================================
            4. MODALES Y OTROS
            ========================================== */
        .modal-overlay { 
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.875); /* OSCURIDAD */
            z-index: 3000; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center; 
            backdrop-filter: blur(12.5px); /* DESENFOQUE */
            -webkit-backdrop-filter: blur(12.5px);}
        #modal-card-container { width: 340px; aspect-ratio: 2 / 3; margin-bottom: 20px; display: flex; justify-content: center;}
        #team-modal-content { background: var(--color-paneles); background-image: var(--url-pizarra); background-size: cover; background-position: center; padding: 20px; border-radius: 8px; border: 1px solid var(--color-bordes); width: 95%; max-width: 950px; max-height: 95vh; display: flex; flex-direction: column; box-shadow: 0 0 100px rgba(24, 60, 93, 0.4);}
        .armador-layout { overflow-y: auto; overflow-x: hidden; flex: 1; padding: 0 10px;}
        .players-list-scroll { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 8px; max-height: 200px; overflow-y: auto;}
        .player-row { display: flex; align-items: center; gap: 10px; padding: 8px; background: #252525; border-radius: 4px; cursor: pointer; font-family: var(--fuente-datos); font-weight: bold; border: 1px solid transparent; box-sizing: border-box;}
        .player-row.selected { border-color: var(--color-acento); color: var(--color-acento);}
        .player-row input[type="checkbox"] { accent-color: var(--color-acento);}
        .teams-container { display: grid; grid-template-columns: 1fr 300px 1fr; gap: 15px; margin-top: 10px; min-height: 250px; width: 100%; padding: 15px 0; align-items: start;}
        .team-box { padding: 10px; border-radius: 6px; border: 2px solid #333; display: flex; flex-direction: column; transition: transform 0.2s ease; height: 100%; box-sizing: border-box;}
        .team-box.highlight { transform: scale(var(--escala-hover-equipo)); z-index: 5; border-color: var(--color-acento);}
        .team-white { background: #ffffff; color: #111; border-color: #ccc; box-shadow: inset 0 0 80px rgba(0,0,0,0.2);}
        .team-black { background: #000000; color: #ffffff; border-color: #333; box-shadow: inset 0 0 80px rgba(255,255,255,0.1);}
        .team-header { font-size: 1.8rem; font-family: var(--fuente-impacto); text-align: center; border-bottom: 2px solid; font-weight: bold; margin-bottom: 5px;}
        .team-avg-label { text-align: center; font-family: var(--fuente-impacto); font-size: 1.1rem; letter-spacing: 1px; padding: 4px 0; border-bottom: 1px solid rgba(0,0,0,0.1);}
        .team-player-li { padding: 8px 10px; border-bottom: 1px solid rgba(0,0,0,0.05); font-size: 1.1rem; font-family: var(--fuente-datos); font-weight: bold; display: flex; justify-content: space-between; align-items: center; cursor: pointer;}
        #radar-container { background: var(--color-acento); border-radius: 8px; padding: 10px; display: flex; align-items: center; justify-content: center; height: 280px; position: relative; border: 2px solid rgba(255,255,255,0.2); box-shadow: 0 4px 15px rgba(0,0,0,0.3);}
        canvas#radarChart { width: 100% !important; height: 100% !important;}
        @media (max-width: 900px) {
            .teams-container { grid-template-columns: 1fr 1fr; gap: 8px;}
            #radar-container { grid-column: span 2; order: 3; height: 240px; margin-top: 10px;}
            .team-header { font-size: 1.2rem;}
            .team-avg-label { font-size: 0.85rem;}
            .team-player-li { font-size: 0.95rem; padding: 5px 6px;}}
        .btn-group { display: flex; flex-direction: row; gap: 10px; justify-content: center; width: 100%; flex-wrap: wrap; margin-top: 10px;}
        .btn-ghost { background: rgba(42, 42, 42, 0.9); color: #fff; border: 1px solid #444;}
        .btn-add-guest { background: #111; border: 1px solid #444; color: #eee; padding: 5px 12px; border-radius: 4px; cursor: pointer; font-size: 0.8rem; font-weight: bold;}
        .modal-footer { display: flex; flex-direction: row; justify-content: flex-end; gap: 15px; padding-top: 15px; width: 100%;}
        .shine-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 4; overflow: hidden; mask-size: contain; mask-repeat: no-repeat; -webkit-mask-size: contain; -webkit-mask-repeat: no-repeat; pointer-events: none;}
        #loader { text-align: center; color: #666; margin-top: 50px; font-family: var(--fuente-impacto); letter-spacing: 2px;}
        #music-control { position:fixed; bottom:20px; right:20px; font-size:2rem; cursor:pointer; z-index:4000; width:45px; display: flex; align-items: center;}
    </style>
</head>
<body>
    <div id="version-tag">v. 12</div>
    <header class="main-sticky-header">
        <div class="header-container" id="header-area"></div>
        <div class="controls-area">
            <input type="text" id="search-input" placeholder="BUSCAR JUGADOR...">
            <select id="sort-select">
                <option value="nombre-asc">Nombre: A - Z</option>
                <option value="nombre-desc">Nombre: Z - A</option>
                <option value="prom-desc">ValoraciÃ³n: mayor a menor</option>
                <option value="prom-asc">ValoraciÃ³n: menor a mayor</option>
            </select>
            <button class="btn" onclick="abrirArmador()">Armar Equipos</button>
        </div>
    </header>
    <div id="loader">CARGANDO JUGADORES...</div>
    <div id="grid-container" class="grid"></div>
    <div id="modal" class="modal-overlay">
        <div id="modal-card-container"></div>
        <div class="btn-group" id="modal-buttons"></div>
    </div>
    <div id="team-modal" class="modal-overlay">
        <div id="team-modal-content">
            <div class="team-title" style="text-align:center; color:var(--color-acento); font-size:2.2rem; font-family:var(--fuente-impacto); letter-spacing:2px; margin-bottom:10px;">ARMADOR DE EQUIPOS</div>
            <div class="armador-layout">
                <div class="selection-area" style="background:rgba(0,0,0,0.4); padding:10px; border-radius:6px; margin-bottom:10px; border:1px solid rgba(255,255,255,0.1);">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                        <span id="team-counter" style="font-weight:bold; color:#ccc; font-size:0.9rem;">SELECCIONADOS: 0 / 10</span>
                        <button class="btn-add-guest" id="btn-add-guest" onclick="agregarInvitado()">+ AGREGAR INVITADO</button>
                    </div>
                    <div id="players-checklist" class="players-list-scroll"></div>
                </div>
                <div style="display: flex; justify-content: center; width: 100%; margin: 15px 0;">
                    <button class="btn" style="background:var(--color-acento); color:#fff; height:45px; font-weight:900; padding: 0 30px; border-radius:6px; cursor:pointer;" onclick="generarAutomatico()" id="btn-generate">Generar automÃ¡tico</button>
                </div>
                <div id="team-capture-area">
                    <div class="teams-container" id="main-teams-layout">
                        <div class="team-box team-white" id="box-team-1" onmouseenter="highlightTeam(0)" onmouseleave="highlightTeam(-1)" onclick="highlightTeam(0)">
                            <div class="team-header">CLARO</div>
                            <div id="avg-team-1" class="team-avg-label">PROM: 0</div>
                            <ul class="team-list-ul" id="list-team-1" style="list-style:none; padding:0; margin:0;"></ul>
                        </div>
                        <div id="radar-container">
                            <canvas id="radarChart"></canvas>
                        </div>
                        <div class="team-box team-black" id="box-team-2" onmouseenter="highlightTeam(1)" onmouseleave="highlightTeam(-1)" onclick="highlightTeam(1)">
                            <div class="team-header">OSCURO</div>
                            <div id="avg-team-2" class="team-avg-label">PROM: 0</div>
                            <ul class="team-list-ul" id="list-team-2" style="list-style:none; padding:0; margin:0;"></ul>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" style="background:var(--color-acento); color:#fff; height:40px; font-weight:900; padding: 0 20px; border-radius:4px; cursor:pointer; display:none; margin-right:auto;" onclick="compartirEquipos()" id="btn-share-teams">Compartir</button>
                <button class="btn btn-ghost" style="height:40px; padding: 0 20px;" onclick="cerrarArmador()">Cerrar</button>
            </div>
        </div>
    </div>
    <audio id="audio-player" loop></audio>
    <audio id="sfx-hover-player"></audio>
    <audio id="sfx-click-player"></audio>
    <div id="music-control" onclick="rotateMusic()">ðŸ”ˆ</div>
<script>
    const CONFIG = {
        MULT_LEYENDA: [1.13, 1.11, 1.09, 1.07, 1.05, 1.03],
        PLUS_EDAD_COEF: 0.0028,
        BONUS_RESISTENCIA: 1.05,
        BONUS_VELOCIDAD: 1.03,
        TOPE_STAT_LEYENDA: 98,
        URL_FONDO: "https://raw.githubusercontent.com/nicolasfaravelli/partido-de-los-martes/main/Fondo.png",
        URL_TITULO: "https://raw.githubusercontent.com/nicolasfaravelli/partido-de-los-martes/main/Titulo.png",
        URL_MUSICA: "https://raw.githubusercontent.com/nicolasfaravelli/partido-de-los-martes/main/Musica.mp3",
        URL_LEYENDA_FONDO: "https://raw.githubusercontent.com/nicolasfaravelli/partido-de-los-martes/main/LEYENDA.png",
        URL_SFX_HOVER: "https://raw.githubusercontent.com/nicolasfaravelli/partido-de-los-martes/main/Click 1.mp3",
        URL_SFX_CLICK: "https://raw.githubusercontent.com/nicolasfaravelli/partido-de-los-martes/main/Click 2.mp3",
        URL_CSV: "https://docs.google.com/spreadsheets/d/e/2PACX-1vTHOyW-OmPwPBpIwBw30sBjYdcLn1_8xFjkXfG9_tLFeB960jfYnnouTDieGPeKSK49FYM1tSGng_mg/pub?gid=1826229647&single=true&output=csv",
        VOL_SERIES: [0, 0.05, 0.2],
        SFX_MAP: { 0: 0, 0.05: 0.0375, 0.2: 0.15 }};
    const COLORES = { 'leyenda': '#644b14', 'legendario': '#372864', 'oro': '#624f21', 'plata': '#434343', 'bronce': '#5e3e21' };
    const STAT_COLORS = { 'legend': '#a855f7', 'gold': '#d4af37', 'silver': '#7a7a7a', 'bronze': '#5e3e21' };
    const ICON_SERIES = ["ðŸ”ˆ", "ðŸ”‰", "ðŸ”Š"];
    let datosOriginales = [], invitados = [], equipo1 = [], equipo2 = [];
    let jugadorActualEnModal = null, esModoLeyenda = false, volIndex = 0, teamRadarChart = null;
    document.addEventListener("DOMContentLoaded", () => {
        if(CONFIG.URL_FONDO) document.documentElement.style.setProperty('--fondo-url', `url('${CONFIG.URL_FONDO}')`);
        if(CONFIG.URL_TITULO) document.getElementById('header-area').innerHTML = `<img src="${CONFIG.URL_TITULO}" class="title-img">`;
        document.getElementById('search-input').addEventListener('input', aplicarFiltrosYOrden);
        document.getElementById('sort-select').addEventListener('change', aplicarFiltrosYOrden);
        window.addEventListener('click', initAudio, {once:true});
        window.addEventListener('touchstart', initAudio, {once:true});
        cargarDatos();
        new MutationObserver(attachSounds).observe(document.body, { childList: true, subtree: true });
        const img = new Image(); img.src = CONFIG.URL_LEYENDA_FONDO;});
    function cargarDatos() {
        const PROXY_URL = "https://corsproxy.io/?" + encodeURIComponent(CONFIG.URL_CSV + "&uid=" + Date.now());
        Papa.parse(PROXY_URL, { download: true, header: false, skipEmptyLines: true, complete: (results) => {
                document.getElementById('loader').style.display = 'none';
                const data = results.data; if(data.length > 0) data.shift();
                datosOriginales = data.map((fila, index) => { if(!fila[0] || fila[0].trim() === 'Jugador') return null;
                    const j = { id: index, nombre: fila[0], prom: parseInt(fila[8]) || 60, ata: parseInt(fila[2]), def: parseInt(fila[3]), tec: parseInt(fila[4]), vel: parseInt(fila[5]), res: parseInt(fila[6]), arq: parseInt(fila[7]), edad: parseInt(fila[1]) || 25, pos: fila[9], fondo: fila[11], foto: fila[12], fotoLeyenda: fila[13] ? fila[13].trim() : "", color: COLORES[fila[10]?.trim().toLowerCase()] || '#624f21' };
                    if(j.fotoLeyenda) { const pre = new Image(); pre.src = j.fotoLeyenda; }
                    return j;}).filter(i => i !== null);
                aplicarFiltrosYOrden();}}); }
    function aplicarFiltrosYOrden() {
        const t = document.getElementById('search-input').value.toLowerCase();
        const [c, o] = document.getElementById('sort-select').value.split('-');
        let lista = datosOriginales.filter(j => j.nombre.toLowerCase().includes(t));
        lista.sort((a,b) => c === 'nombre' ? (o === 'asc' ? a.nombre.localeCompare(b.nombre) : b.nombre.localeCompare(a.nombre)) : (o === 'asc' ? a.prom - b.prom : b.prom - a.prom));
        document.getElementById('grid-container').innerHTML = lista.map(j => `<div class="card" onclick="abrirModal(${j.id})">${generarHTMLCarta(j, true)}</div>`).join('');
        attachSounds();}
    function generarHTMLCarta(j, lazy) { 
        return `<div class="card-bg-wrapper"><img src="${j.fondo}" class="card-bg" ${lazy?'loading="lazy"':''} crossorigin="anonymous"></div><div class="shine-layer" style="mask-image:url('${j.fondo}'); -webkit-mask-image:url('${j.fondo}');"></div>${j.foto ? `<img src="${j.foto}" class="card-face" crossorigin="anonymous">` : ''}<div class="info-layer" style="color:${j.color}"><div class="rating">${j.prom}</div><div class="position">${j.pos}</div><div class="name">${j.nombre}</div><div class="stats-container"><span class="stat-val">${j.ata}</span><span class="stat-val">${j.def}</span><span class="stat-val">${j.tec}</span><span class="stat-val">${j.vel}</span><span class="stat-val">${j.res}</span><span class="stat-val">${j.arq}</span></div></div>`;}
    function abrirModal(id) { 
        const j = datosOriginales.find(x => x.id === parseInt(id)); 
        jugadorActualEnModal = JSON.parse(JSON.stringify(j)); 
        esModoLeyenda = false; 
        document.getElementById('modal-card-container').innerHTML = '';
        if(j.fotoLeyenda) { const pre = new Image(); pre.src = j.fotoLeyenda; pre.decode().then(() => renderizarModal(jugadorActualEnModal)).catch(() => renderizarModal(jugadorActualEnModal)); } 
        else { renderizarModal(jugadorActualEnModal); }
        document.getElementById('modal').style.display = 'flex'; 
        document.body.classList.add('modal-open');}
    function renderizarModal(j) { document.getElementById('modal-card-container').innerHTML = `<div class="card" id="carta-descarga">${generarHTMLCarta(j, false)}</div>`; document.getElementById('modal-buttons').innerHTML = `${j.fotoLeyenda ? `<button class="btn ${esModoLeyenda?'btn-ghost':'btn-gold'}" style="height:45px; padding:0 20px; border-radius:4px; font-weight:900; cursor:pointer;" onclick="toggleLeyenda()">${esModoLeyenda?"ACTUAL":"LEYENDA"}</button>`:''}<button class="btn" style="background:var(--color-acento); color:#fff; height:45px; padding:0 20px; border-radius:4px; font-weight:900; cursor:pointer;" onclick="descargarCarta()">DESCARGAR</button><button class="btn btn-ghost" style="height:45px; padding: 0 20px; border-radius:6px;" onclick="cerrarModalCarta()">CERRAR</button>`; attachSounds();}
    function cerrarModalCarta() { document.getElementById('modal').style.display='none'; document.body.classList.remove('modal-open');}
    function toggleLeyenda() { 
        esModoLeyenda = !esModoLeyenda; 
        const j = esModoLeyenda ? calcularObjetoLeyenda(jugadorActualEnModal) : jugadorActualEnModal; 
        renderizarModal(j); 
        const card = document.getElementById('carta-descarga');
        const foto = card.querySelector('.card-face'); 
        if(card) {card.classList.add('flash-evolucion');
        if(foto) foto.classList.add('flash-foto'); 
        setTimeout(() => {
        card.classList.remove('flash-evolucion');
        if(foto) foto.classList.remove('flash-foto');}, 600);}}
    function calcularObjetoLeyenda(base) { const keys = ['ata','def','tec','vel','res','arq']; const sorted = keys.map(k => ({k, v: base[k]})).sort((a,b)=>b.v-a.v); let nuevos = {}, suma = 0; const plus = Math.max(0, (base.edad - 33) * CONFIG.PLUS_EDAD_COEF); sorted.forEach((s, i) => { let m = CONFIG.MULT_LEYENDA[i] || 1.05; let val = s.v * (m + plus); if(s.k === 'res') val *= CONFIG.BONUS_RESISTENCIA; if(s.k === 'vel') val *= CONFIG.BONUS_VELOCIDAD; nuevos[s.k] = Math.min(CONFIG.TOPE_STAT_LEYENDA, Math.round(val)); suma += nuevos[s.k]; }); return { ...base, foto: base.fotoLeyenda, fondo: "https://raw.githubusercontent.com/nicolasfaravelli/partido-de-los-martes/main/LEYENDA.png", color: COLORES['leyenda'], ...nuevos, prom: Math.min(98, Math.round(suma/6)) };}
    function descargarCarta() { const el = document.getElementById('carta-descarga'); el.querySelector('.shine-layer').style.display = 'none'; html2canvas(el, { useCORS: true, scale: 3 }).then(cvs => { const a = document.createElement('a'); a.download = 'Carta.png'; a.href = cvs.toDataURL(); a.click(); el.querySelector('.shine-layer').style.display = 'block'; });}
    function abrirArmador() { document.getElementById('team-modal').style.display = 'flex'; document.body.classList.add('modal-open'); equipo1 = []; equipo2 = []; renderizarListaSeleccion();}
    function cerrarArmador() { document.getElementById('team-modal').style.display = 'none'; document.body.classList.remove('modal-open');}
    function agregarInvitado() { if((equipo1.length + equipo2.length) >= 10) return; const id = 9000 + invitados.length + 1; invitados.push({id, nombre: `Invitado ${invitados.length+1}`, prom: 70, ata: 70, def: 70, tec: 70, vel: 70, res: 70, arq: 50, edad: 25, esInvitado: true}); (equipo1.length <= equipo2.length ? equipo1 : equipo2).push(id); renderizarListaSeleccion();}
    function borrarInvitado(id) { invitados = invitados.filter(i => i.id !== parseInt(id)); equipo1 = equipo1.filter(x=>x!==parseInt(id)); equipo2 = equipo2.filter(x=>x!==parseInt(id)); renderizarListaSeleccion();}
    function isPlayerSelected(id) { return equipo1.includes(parseInt(id)) || equipo2.includes(parseInt(id));}
    function editarInvitado(id, campo, valor) { const inv = invitados.find(i => i.id === parseInt(id)); if (inv) { if (campo === 'nombre') inv.nombre = valor; else if (campo === 'prom') { inv.prom = inv.ata = inv.def = inv.tec = inv.vel = inv.res = parseInt(valor) || 0; } actualizarTablerosEquipos();}}
    function renderizarListaSeleccion() {
        const cont = document.getElementById('players-checklist');
        let html = invitados.map(i => `<div class="player-row selected" onclick="toggleSeleccion(${i.id})"><span>${i.nombre}</span> <span style="margin-left:auto;color:${getColorProm(i.prom)}">${i.prom}</span></div>`).join('');
        html += datosOriginales.map(j => {
            const sel = equipo1.includes(j.id) || equipo2.includes(j.id);
            return `<div class="player-row ${sel?'selected':''}" onclick="toggleSeleccion(${j.id})"><span>${j.nombre}</span> <span style="left:auto; margin-left:auto; color:${getColorProm(j.prom)}">${j.prom}</span></div>`;}).join('');
        cont.innerHTML = html;
        actualizarContadorEquipos(); actualizarTablerosEquipos();}
    function toggleSeleccion(id) { const nid = parseInt(id); if (isPlayerSelected(nid)) { equipo1 = equipo1.filter(x=>x!==nid); equipo2 = equipo2.filter(x=>x!==nid); } else if ((equipo1.length + equipo2.length) < 10) (equipo1.length <= equipo2.length ? equipo1 : equipo2).push(nid); renderizarListaSeleccion();}
    function actualizarContadorEquipos() { const t = equipo1.length + equipo2.length; const cnt = document.getElementById('team-counter'); const ok = t === 10; cnt.innerText = `SELECCIONADOS: ${t} / 10`; if(ok) cnt.classList.add('completado'); else cnt.classList.remove('completado'); document.getElementById('btn-generate').disabled = !ok; document.getElementById('btn-share-teams').style.display = ok ? 'block' : 'none';}
    function getPlayerData(id) { return id >= 9000 ? invitados.find(i=>i.id===id) : datosOriginales.find(d=>d.id===id);}
    function actualizarTablerosEquipos() { renderListaEquipo('list-team-1', equipo1, 'avg-team-1'); renderListaEquipo('list-team-2', equipo2, 'avg-team-2'); actualizarRadar();}
    function renderListaEquipo(ulId, ids, avgId) { const ul = document.getElementById(ulId); ul.innerHTML = ''; let suma = 0; ids.map(getPlayerData).forEach(p => { suma += p.prom; const li = document.createElement('li'); li.className = 'team-player-li'; li.style.display="flex"; li.style.justifyContent="space-between"; li.style.padding="8px"; li.style.borderBottom="1px solid #333"; li.innerHTML = `<span>${p.nombre}</span><span style="color:${getColorProm(p.prom)}">${p.prom}</span>`; ul.appendChild(li); }); document.getElementById(avgId).innerText = `PROM: ${ids.length ? (suma/ids.length).toFixed(1) : 0}`;}
    function getColorProm(v) { return v>=90?STAT_COLORS.legend:v>=80?STAT_COLORS.gold:v>=70?STAT_COLORS.silver:STAT_COLORS.bronze;}
    function highlightTeam(idx) {
        if(!teamRadarChart) return;
        document.querySelectorAll('.team-box').forEach((el, i) => { if(i === idx) el.classList.add('highlight'); else el.classList.remove('highlight'); });
        teamRadarChart.update('none');}
    function actualizarRadar() {
        const getAvgStats = (ids) => {
            if (!ids.length) return [0,0,0,0,0,0];
            const ps = ids.map(getPlayerData);
            const sum = ps.reduce((acc, p) => ({ ata: acc.ata + (p.ata || 0), def: acc.def + (p.def || 0), tec: acc.tec + (p.tec || 0), vel: acc.vel + (p.vel || 0), res: acc.res + (p.res || 0), arq: acc.arq + (p.arq || 0) }), {ata:0, def:0, tec:0, vel:0, res:0, arq:0});
            return [sum.ata/ids.length, sum.def/ids.length, sum.tec/ids.length, sum.vel/ids.length, sum.res/ids.length, sum.arq/ids.length];};
        const data1 = getAvgStats(equipo1), data2 = getAvgStats(equipo2);
        if (!teamRadarChart) {
            const ctx = document.getElementById('radarChart').getContext('2d');
            teamRadarChart = new Chart(ctx, { type: 'radar', data: { labels: ['ATA', 'DEF', 'TEC', 'VEL', 'RES', 'ARQ'], datasets: [ { label: 'CLARO', data: data1, backgroundColor: 'rgba(255, 255, 255, 0.4)', borderColor: '#ffffff', borderWidth: 3, pointRadius: 0 }, { label: 'OSCURO', data: data2, backgroundColor: 'rgba(0, 0, 0, 0.5)', borderColor: '#000000', borderWidth: 3, pointRadius: 0 } ] }, options: { animation: { duration: 250 }, responsive: true, maintainAspectRatio: false, scales: { r: { min: 30, max: 100, ticks: { display: false }, grid: { color: 'rgba(255,255,255,0.15)' }, angleLines: { color: 'rgba(255,255,255,0.15)' }, pointLabels: { color: '#ffffff', font: { family: 'Bebas Neue', size: 16 } } } }, plugins: { legend: { display: false } } } });
        } else { teamRadarChart.data.datasets[0].data = data1; teamRadarChart.data.datasets[1].data = data2; teamRadarChart.update(); }}
    function generarAutomatico() {
        let pool = [...equipo1, ...equipo2].map(getPlayerData); if (pool.length !== 10) return;
        let mejorE1 = [], mejorFealdad = 999999;
        for (let i = 0; i < 500; i++) {
            let t = [...pool].sort(() => Math.random() - 0.5);
            let t1 = t.slice(0, 5), t2 = t.slice(5);
            let s1 = t1.reduce((a,b)=>a+b.prom, 0), s2 = t2.reduce((a,b)=>a+b.prom, 0);
            let f = Math.abs(s1 - s2) * 10; 
            const graneros = t.filter(p => p.nombre.toUpperCase().includes("GRANERO"));
            if(graneros.length > 1) { const gEnT1 = t1.filter(p => p.nombre.toUpperCase().includes("GRANERO")).length; if(gEnT1 > 0 && gEnT1 < graneros.length) f += 10000; }
            if (f < mejorFealdad) { mejorFealdad = f; mejorE1 = t1.map(p=>p.id); }}
        equipo1 = mejorE1; equipo2 = pool.map(p=>p.id).filter(id => !equipo1.includes(id));
        actualizarTablerosEquipos();}
    function compartirEquipos() { 
        const radar = document.getElementById('radar-container');
        const container = document.getElementById('main-teams-layout');
        radar.style.display = 'none'; container.style.gridTemplateColumns = "1fr 1fr"; 
        html2canvas(document.getElementById('team-capture-area'), { backgroundColor: '#1a1a1a', scale: 2, useCORS: true }).then(canvas => {
            radar.style.display = 'flex'; container.style.gridTemplateColumns = "1fr 300px 1fr";
            canvas.toBlob(blob => { 
                const file = new File([blob], "equipos.png", { type: "image/png" }); 
                if(navigator.share) navigator.share({ files: [file], title: 'Equipos' }); 
                else { const a = document.createElement('a'); a.download = 'Equipos.png'; a.href = canvas.toDataURL(); a.click(); }}); }); }
    function initAudio() { const p = document.getElementById('audio-player'); if(!p.src) { p.src = CONFIG.URL_MUSICA; p.volume = CONFIG.VOL_SERIES[0]; } p.play().catch(() => {});}
    function rotateMusic() { const p = document.getElementById('audio-player'); volIndex = (volIndex + 1) % CONFIG.VOL_SERIES.length; p.volume = CONFIG.VOL_SERIES[volIndex]; document.getElementById('music-control').innerText = ICON_SERIES[volIndex]; if (p.volume > 0) p.play(); else p.pause();}
    function playHoverSfx() { const s = document.getElementById('sfx-hover-player'); s.src = CONFIG.URL_SFX_HOVER; s.volume = CONFIG.SFX_MAP[CONFIG.VOL_SERIES[volIndex]] ?? 0.03; s.play().catch(()=>{});}
    function playClickSfx() { const s = document.getElementById('sfx-click-player'); s.src = CONFIG.URL_SFX_CLICK; s.volume = CONFIG.SFX_MAP[CONFIG.VOL_SERIES[volIndex]] ?? 0.15; s.play().catch(()=>{});}
    function attachSounds() {
        document.querySelectorAll('.btn, .card, .player-row, .team-player-li').forEach(el => {
            if(!el.dataset.soundAttached) {
                if(!el.classList.contains('player-row')) el.addEventListener('mouseenter', playHoverSfx);
                el.addEventListener('mousedown', (e) => { if(el.classList.contains('player-row')) playHoverSfx(); else playClickSfx(); });
                el.dataset.soundAttached = "true";}}); }
</script>
</body>
</html>











