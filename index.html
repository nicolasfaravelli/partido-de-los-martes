<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Partido de los Martes</title>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* ==========================================
            1. AJUSTES ESTTICOS (Variables)
           ========================================== */
        :root {
            --color-acento: #75AADB; 
            --color-acento-off: #3d4e5f;          
            --color-fondo: #0f0f0f; 
            --color-paneles: #1a1a1a; 
            --color-bordes: #333333;
            --fuente-impacto: 'Bebas Neue', sans-serif;
            --fuente-datos: 'Montserrat', sans-serif;
            --url-pizarra: url('https://raw.githubusercontent.com/nicolasfaravelli/partido-de-los-martes/main/Fondo%20armador.png');
            --blur-fondo-modal: blur(10px);        
            --escala-hover-equipo: 1.025;         
            --brillo-celeste-cuadro: 0 0 100px rgba(24, 60, 93, 0.4); 
            --gloss-claro: inset 0 0 80px rgba(0,0,0,0.2);
            --gloss-oscuro: inset 0 0 80px rgba(255,255,255,0.1);
        }

        /* ==========================================
            2. BRILLITOS Y ANIMACIONES (NO TOCAR)
           ========================================== */
        body { background-color: var(--color-fondo); color: #fff; font-family: var(--fuente-datos); margin: 0; padding: 0 20px 20px 20px; background-image: var(--fondo-url); background-position: center; background-repeat: no-repeat; background-size: cover; background-attachment: fixed; user-select: none; }
        
        /* Brillo diagonal al pasar el mouse */
        .card::after {
            content: ""; position: absolute; top: -50%; left: -60%; width: 25%; height: 200%;
            background: rgba(255, 255, 255, 0.15); transform: rotate(30deg);
            transition: all 0.6s; opacity: 0; pointer-events: none; z-index: 5;
        }
        .card:hover::after { left: 125%; opacity: 1; }

        /* Animaci贸n de transici贸n Modo Leyenda */
        .trigger-shine { animation: shine-sweep 0.8s ease-in-out; }
        .trigger-shine-reverse { animation: shine-sweep-reverse 0.8s ease-in-out; }
        
        @keyframes shine-sweep {
            0% { filter: brightness(1) contrast(1); }
            50% { filter: brightness(1.8) contrast(1.2); }
            100% { filter: brightness(1) contrast(1); }
        }
        @keyframes shine-sweep-reverse {
            0% { filter: brightness(1); }
            50% { filter: brightness(1.4); }
            100% { filter: brightness(1); }
        }

        .shine-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 4; overflow: hidden; mask-size: contain; mask-repeat: no-repeat; -webkit-mask-size: contain; -webkit-mask-repeat: no-repeat; pointer-events: none; }

        @keyframes glow-flash { 0% { text-shadow: 0 0 0px #C6DCF0; } 50% { text-shadow: 0 0 20px #C6DCF0; } 100% { text-shadow: 0 0 0px #C6DCF0; } }
        #team-counter.completado { color: var(--color-acento) !important; animation: glow-flash 0.4s ease; }

        /* ==========================================
            3. ESTRUCTURA (Layout)
           ========================================== */
        .header-container { text-align: center; position: sticky; top: 0; z-index: 100; margin: 0 -20px 10px -20px; padding: 20px 0; }
        .header-container::before { content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; background-color: var(--color-fondo); background-image: var(--fondo-url); background-position: center; background-repeat: no-repeat; background-size: cover; background-attachment: fixed; opacity: 0.95; box-shadow: 0 10px 20px rgba(0,0,0,0.5); border-bottom: 1px solid rgba(255,255,255,0.1); }
        .title-img { max-width: 85%; height: auto; max-height: 120px; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.5)); }

        .controls-area { max-width: 1200px; margin: 0 auto 20px; display: flex; gap: 15px; flex-wrap: wrap; background: rgba(20, 20, 20, 0.95); padding: 15px; border-radius: 8px; border: 1px solid var(--color-bordes); justify-content: space-between; align-items: center; position: relative; z-index: 50; }
        #search-input, #sort-select { flex: 1; height: 45px; padding: 0 15px; background: #2a2a2a; border: 1px solid #444; color: white; border-radius: 4px; min-width: 150px; outline: none; font-family: var(--fuente-datos); }

        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 20px; max-width: 1200px; margin: 0 auto; padding-bottom: 50px; }
        .card { position: relative; width: 100%; aspect-ratio: 2 / 3; cursor: pointer; transition: transform 0.2s; container-type: size; outline: none; -webkit-tap-highlight-color: transparent; }
        .card:hover { transform: scale(1.05); z-index: 10; }
        .card-bg-wrapper { position: absolute; top: 0; left: 0; width: 100%; height: 100%; overflow: hidden; filter: drop-shadow(0 5px 6px rgba(0,0,0,0.6)); }
        .card-bg { width: 100%; height: 100%; object-fit: contain; }
        .card-face { position: absolute; z-index: 2; top: 9.75%; left: 5.25%; width: 95%; object-fit: contain; }
        .info-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 3; pointer-events: none; }
        .rating { font-family: var(--fuente-impacto); position: absolute; top: 13.5%; left: 6%; font-size: 18cqw; text-align: center; width: 25%; line-height: 0.8; }
        .name { font-family: var(--fuente-impacto); position: absolute; top: 64.25%; left: 5%; width: 90%; text-align: center; font-size: 14.5cqw; text-transform: uppercase; }
        .stats-container { display: flex; justify-content: space-between; position: absolute; top: 81%; left: 8%; width: 84.1%; }
        .stat-val { font-family: var(--fuente-impacto); font-size: 8.5cqw; display: block; text-align: center; width: 16%; }

        /* Modales y Armador */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 3000; flex-direction: column; justify-content: center; align-items: center; backdrop-filter: var(--blur-fondo-modal); }
        #team-modal-content { background: var(--color-paneles); background-image: var(--url-pizarra); background-size: cover; background-position: center; padding: 20px; border-radius: 8px; border: 1px solid var(--color-bordes); width: 95%; max-width: 950px; max-height: 95vh; display: flex; flex-direction: column; box-shadow: var(--brillo-celeste-cuadro); }
        .armador-layout { overflow-y: auto; overflow-x: hidden; flex: 1; padding: 0 10px; }

        .teams-container { display: grid; grid-template-columns: 1fr 300px 1fr; gap: 15px; margin-top: 10px; min-height: 250px; width: 100%; padding: 15px 0; align-items: start; }
        .team-box { padding: 10px; border-radius: 6px; border: 2px solid #333; display: flex; flex-direction: column; transition: transform 0.2s ease; height: 100%; box-sizing: border-box; }
        .team-box.highlight { transform: scale(var(--escala-hover-equipo)); z-index: 5; border-color: var(--color-acento); }
        .team-white { background: #ffffff; color: #111; border-color: #ccc; box-shadow: var(--gloss-claro); }
        .team-black { background: #000000; color: #ffffff; border-color: #333; box-shadow: var(--gloss-oscuro); }
        .team-header { font-size: 1.8rem; font-family: var(--fuente-impacto); text-align: center; border-bottom: 2px solid; font-weight: bold; margin-bottom: 5px; }

        .modal-footer { display: flex; flex-direction: row; justify-content: space-between; align-items: center; gap: 15px; padding-top: 15px; width: 100%; }

        .btn { border: 1px solid transparent; padding: 12px 20px; border-radius: 4px; cursor: pointer; font-family: var(--fuente-datos); font-weight: 900; font-size: 1.1rem; display: flex; align-items: center; gap: 8px; justify-content: center; transition: all 0.2s; letter-spacing: 0.8px; text-transform: uppercase; }
        .btn-gold { background: var(--color-acento); color: #fff; }
        .btn-ghost { background: rgba(42, 42, 42, 0.9); color: #fff; border: 1px solid #444; }
        #music-control { position:fixed; bottom:20px; right:20px; font-size:2rem; cursor:pointer; z-index:4000; width:45px; display: flex; align-items: center; }
    </style>
</head>

<body>
    <div id="version-tag">v. 14.8 (Final Fixed)</div>
    <div class="header-container" id="header-area"></div>
    
    <div class="controls-area">
        <input type="text" id="search-input" placeholder="BUSCAR JUGADOR...">
        <select id="sort-select">
            <option value="nombre-asc">Nombre: A - Z</option>
            <option value="nombre-desc">Nombre: Z - A</option>
            <option value="prom-desc">Valoraci贸n: mayor a menor</option>
            <option value="prom-asc">Valoraci贸n: menor a mayor</option>
        </select>
        <button class="btn btn-gold" onclick="abrirArmador()">Armar Equipos</button>
    </div>

    <div id="loader" style="text-align:center; color:#666; margin-top:50px; font-family:var(--fuente-impacto); letter-spacing:2px;">CARGANDO JUGADORES...</div>
    <div id="grid-container" class="grid"></div>

    <div id="modal" class="modal-overlay">
        <div id="modal-card-container"></div>
        <div class="btn-group" id="modal-buttons"></div>
    </div>

    <div id="team-modal" class="modal-overlay">
        <div id="team-modal-content">
            <div class="team-title" style="text-align:center; color:var(--color-acento); font-size:2.2rem; font-family:var(--fuente-impacto); letter-spacing:2px; margin-bottom:10px;">ARMADOR DE EQUIPOS</div>
            <div class="armador-layout">
                <div class="selection-area" style="background:rgba(0,0,0,0.4); padding:10px; border-radius:6px; margin-bottom:10px; border:1px solid rgba(255,255,255,0.1);">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                        <span id="team-counter" style="font-weight:bold; color:#ccc; font-size:0.9rem;">SELECCIONADOS: 0 / 10</span>
                        <button class="btn" style="padding:5px 12px; font-size:0.8rem; background:#111; color:#eee;" onclick="agregarInvitado()">+ INVITADO</button>
                    </div>
                    <div id="players-checklist" class="players-list-scroll" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 8px; max-height: 200px; overflow-y: auto;"></div>
                </div>
                
                <button class="btn btn-gold" style="width:100%; margin: 15px 0;" onclick="generarAutomatico()" id="btn-generate">Generar autom谩tico</button>

                <div id="team-capture-area">
                    <div class="teams-container" id="main-teams-layout">
                        <div class="team-box team-white" id="box-team-1">
                            <div class="team-header">CLARO</div>
                            <div id="avg-team-1" style="text-align:center; font-family:var(--fuente-impacto);">PROM: 0</div>
                            <ul id="list-team-1" style="list-style:none; padding:0; margin:0;"></ul>
                        </div>
                        <div id="radar-container" style="height:280px;"><canvas id="radarChart"></canvas></div>
                        <div class="team-box team-black" id="box-team-2">
                            <div class="team-header">OSCURO</div>
                            <div id="avg-team-2" style="text-align:center; font-family:var(--fuente-impacto);">PROM: 0</div>
                            <ul id="list-team-2" style="list-style:none; padding:0; margin:0;"></ul>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-gold" onclick="compartirEquipos()" id="btn-share-teams" style="display:none;">Compartir</button>
                <button class="btn btn-ghost" onclick="cerrarArmador()">Cerrar</button>
            </div>
        </div>
    </div>

    <audio id="audio-player" loop></audio>
    <audio id="sfx-hover-player"></audio>
    <audio id="sfx-click-player"></audio>
    <div id="music-control" onclick="rotateMusic()"></div>

<script>
    /* ==========================================
        4. PANEL DE CONTROL (Toc谩 ac谩)
       ========================================== */
    const CONFIG = {
        // Multiplicadores Leyenda
        MULT_LEYENDA: [1.13, 1.11, 1.09, 1.07, 1.05, 1.03],
        PLUS_EDAD_COEF: 0.0028,
        TOPE_STAT_LEYENDA: 98,
        
        // URLs y Datos
        URL_CSV: "https://docs.google.com/spreadsheets/d/e/2PACX-1vTHOyW-OmPwPBpIwBw30sBjYdcLn1_8xFjkXfG9_tLFeB960jfYnnouTDieGPeKSK49FYM1tSGng_mg/pub?gid=1826229647&single=true&output=csv",
        URL_MUSICA: "https://raw.githubusercontent.com/nicolasfaravelli/partido-de-los-martes/main/Musica.mp3",
        URL_SFX_HOVER: "https://raw.githubusercontent.com/nicolasfaravelli/partido-de-los-martes/main/Click 1.mp3",
        URL_SFX_CLICK: "https://raw.githubusercontent.com/nicolasfaravelli/partido-de-los-martes/main/Click 2.mp3",

        // Vol煤menes de m煤sica [Nivel 1, Nivel 2, Silencio]
        VOL_MUSICA: [0.05, 0.2, 0],
        // Volumen de clicks vinculado a la m煤sica
        SFX_MAP: { 0: 0, 0.05: 0.0375, 0.2: 0.15 }
    };

    const COLORES = { 'leyenda': '#644b14', 'legendario': '#372864', 'oro': '#624f21', 'plata': '#434343', 'bronce': '#5e3e21' };
    const STAT_COLORS = { 'legend': '#a855f7', 'gold': '#d4af37', 'silver': '#7a7a7a', 'bronze': '#5e3e21' };

    /* ==========================================
        5. LGICA DE FUNCIONAMIENTO (No tocar)
       ========================================== */
    let datosOriginales = [], invitados = [], equipo1 = [], equipo2 = [];
    let jugadorActualEnModal = null, esModoLeyenda = false, volIndex = 0, teamRadarChart = null;

    document.addEventListener("DOMContentLoaded", () => {
        cargarDatos();
        document.getElementById('search-input').addEventListener('input', aplicarFiltrosYOrden);
        document.getElementById('sort-select').addEventListener('change', aplicarFiltrosYOrden);
        window.addEventListener('click', initAudio, {once: true});
        new MutationObserver(attachSounds).observe(document.body, { childList: true, subtree: true });
    });

    function cargarDatos() {
        const PROXY_URL = "https://corsproxy.io/?" + encodeURIComponent(CONFIG.URL_CSV + "&uid=" + Date.now());
        Papa.parse(PROXY_URL, { download: true, header: false, skipEmptyLines: true, complete: (res) => {
            document.getElementById('loader').style.display = 'none';
            datosOriginales = res.data.slice(1).map((f, i) => ({
                id: i, nombre: f[0], prom: parseInt(f[8]) || 60, ata: parseInt(f[2]), def: parseInt(f[3]), tec: parseInt(f[4]), vel: parseInt(f[5]), res: parseInt(f[6]), arq: parseInt(f[7]), edad: parseInt(f[1]) || 25, pos: f[9], fondo: f[11], foto: f[12], fotoLeyenda: f[13], color: COLORES[f[10]?.trim().toLowerCase()] || '#624f21'
            })).filter(j => j.nombre);
            aplicarFiltrosYOrden();
        }});
    }

    function aplicarFiltrosYOrden() {
        const busqueda = document.getElementById('search-input').value.toLowerCase();
        const [crit, ord] = document.getElementById('sort-select').value.split('-');
        let lista = datosOriginales.filter(j => j.nombre.toLowerCase().includes(busqueda));
        lista.sort((a,b) => crit === 'nombre' ? (ord === 'asc' ? a.nombre.localeCompare(b.nombre) : b.nombre.localeCompare(a.nombre)) : (ord === 'asc' ? a.prom - b.prom : b.prom - a.prom));
        document.getElementById('grid-container').innerHTML = lista.map(j => `<div class="card" onclick="abrirModal(${j.id})">${generarHTMLCarta(j, true)}</div>`).join('');
        attachSounds();
    }

    function generarHTMLCarta(j, lazy) {
        return `<div class="card-bg-wrapper"><img src="${j.fondo}" class="card-bg" crossorigin="anonymous"></div>
                <div class="shine-layer" style="mask-image:url('${j.fondo}'); -webkit-mask-image:url('${j.fondo}');"></div>
                ${j.foto ? `<img src="${j.foto}" class="card-face" crossorigin="anonymous">` : ''}
                <div class="info-layer" style="color:${j.color}">
                    <div class="rating">${j.prom}</div>
                    <div class="name">${j.nombre}</div>
                    <div class="stats-container">
                        <span class="stat-val">${j.ata}</span><span class="stat-val">${j.def}</span><span class="stat-val">${j.tec}</span>
                        <span class="stat-val">${j.vel}</span><span class="stat-val">${j.res}</span><span class="stat-val">${j.arq}</span>
                    </div>
                </div>`;
    }

    function abrirModal(id) {
        const j = datosOriginales.find(x => x.id === id);
        jugadorActualEnModal = JSON.parse(JSON.stringify(j));
        esModoLeyenda = false;
        document.getElementById('modal').style.display = 'flex';
        renderizarModal(jugadorActualEnModal);
    }

    function renderizarModal(j) {
        document.getElementById('modal-card-container').innerHTML = `<div class="card" id="carta-descarga">${generarHTMLCarta(j, false)}</div>`;
        document.getElementById('modal-buttons').innerHTML = `
            ${j.fotoLeyenda ? `<button class="btn btn-gold" onclick="toggleLeyenda()">LEYENDA</button>` : ''}
            <button class="btn btn-gold" onclick="descargarCarta()">DESCARGAR</button>
            <button class="btn btn-ghost" onclick="cerrarModalCarta()">CERRAR</button>`;
        attachSounds();
    }

    function toggleLeyenda() {
        esModoLeyenda = !esModoLeyenda;
        const j = esModoLeyenda ? calcularLeyenda(jugadorActualEnModal) : jugadorActualEnModal;
        renderizarModal(j);
        const card = document.getElementById('carta-descarga');
        card.classList.remove('trigger-shine', 'trigger-shine-reverse');
        void card.offsetWidth;
        card.classList.add(esModoLeyenda ? 'trigger-shine' : 'trigger-shine-reverse');
    }

    function calcularLeyenda(base) {
        const keys = ['ata','def','tec','vel','res','arq'];
        const sorted = keys.map(k => ({k, v: base[k]})).sort((a,b)=>b.v-a.v);
        let nuevos = {}, suma = 0;
        const plus = Math.max(0, (base.edad - 33) * CONFIG.PLUS_EDAD_COEF);
        sorted.forEach((s, i) => {
            let val = s.v * (CONFIG.MULT_LEYENDA[i] + plus);
            nuevos[s.k] = Math.min(CONFIG.TOPE_STAT_LEYENDA, Math.round(val));
            suma += nuevos[s.k];
        });
        return { ...base, foto: base.fotoLeyenda, fondo: "https://raw.githubusercontent.com/nicolasfaravelli/partido-de-los-martes/main/LEYENDA.png", color: COLORES['leyenda'], ...nuevos, prom: Math.min(98, Math.round(suma/6)) };
    }

    function abrirArmador() { document.getElementById('team-modal').style.display='flex'; equipo1 = []; equipo2 = []; renderListaSeleccion(); }
    function cerrarArmador() { document.getElementById('team-modal').style.display='none'; }
    function cerrarModalCarta() { document.getElementById('modal').style.display='none'; }

    function renderListaSeleccion() {
        const cont = document.getElementById('players-checklist');
        const total = equipo1.length + equipo2.length;
        let html = invitados.map(i => `<div class="player-row" onclick="togglePlayer(${i.id})">${i.nombre} (${i.prom})</div>`).join('');
        html += datosOriginales.map(j => {
            const sel = equipo1.includes(j.id) || equipo2.includes(j.id);
            return `<div class="player-row ${sel?'selected':''}" onclick="togglePlayer(${j.id})">${j.nombre} (${j.prom})</div>`;
        }).join('');
        cont.innerHTML = html;
        actualizarContador();
        actualizarTableros();
    }

    function togglePlayer(id) {
        if (equipo1.includes(id)) equipo1 = equipo1.filter(x=>x!==id);
        else if (equipo2.includes(id)) equipo2 = equipo2.filter(x=>x!==id);
        else if (equipo1.length + equipo2.length < 10) (equipo1.length <= equipo2.length ? equipo1 : equipo2).push(id);
        renderListaSeleccion();
    }

    function generarAutomatico() {
        let pool = [...equipo1, ...equipo2].map(id => id >= 9000 ? invitados.find(x=>x.id===id) : datosOriginales.find(x=>x.id===id));
        if (pool.length !== 10) return;
        
        let mejorE1 = [], mejorFealdad = 999999;
        for (let i = 0; i < 1500; i++) {
            let t = [...pool].sort(() => Math.random() - 0.5);
            let t1 = t.slice(0, 5), t2 = t.slice(5);
            let s1 = t1.reduce((a,b)=>a+b.prom, 0), s2 = t2.reduce((a,b)=>a+b.prom, 0);
            let f = Math.abs(s1 - s2);
            
            // Fuerza a que los Graneros jueguen juntos
            const graneros = t.filter(p => p.nombre.toLowerCase().includes("graneros"));
            if(graneros.length > 1) {
                const gEnT1 = t1.filter(p => p.nombre.toLowerCase().includes("graneros")).length;
                if(gEnT1 !== 0 && gEnT1 !== graneros.length) f += 100;
            }

            if (f < mejorFealdad) { mejorFealdad = f; mejorE1 = t1.map(p=>p.id); }
        }
        equipo1 = mejorE1;
        equipo2 = pool.map(p=>p.id).filter(id => !equipo1.includes(id));
        actualizarTableros();
    }

    function actualizarTableros() {
        const render = (ul, ids) => {
            ul.innerHTML = ids.map(id => {
                const p = id >= 9000 ? invitados.find(x=>x.id===id) : datosOriginales.find(x=>x.id===id);
                return `<li style="padding:8px; border-bottom:1px solid #333; display:flex; justify-content:space-between;">${p.nombre} <span>${p.prom}</span></li>`;
            }).join('');
        };
        render(document.getElementById('list-team-1'), equipo1);
        render(document.getElementById('list-team-2'), equipo2);
        document.getElementById('avg-team-1').innerText = "PROM: " + (equipo1.reduce((a,b)=>a+(b>=9000?invitados.find(x=>x.id===b).prom:datosOriginales.find(x=>x.id===b).prom),0)/5 || 0).toFixed(1);
        document.getElementById('avg-team-2').innerText = "PROM: " + (equipo2.reduce((a,b)=>a+(b>=9000?invitados.find(x=>x.id===b).prom:datosOriginales.find(x=>x.id===b).prom),0)/5 || 0).toFixed(1);
        document.getElementById('btn-share-teams').style.display = (equipo1.length+equipo2.length === 10) ? 'block' : 'none';
        actualizarRadar();
    }

    function actualizarContador() {
        const t = equipo1.length + equipo2.length;
        const el = document.getElementById('team-counter');
        el.innerText = `SELECCIONADOS: ${t} / 10`;
        if(t===10) el.classList.add('completado'); else el.classList.remove('completado');
    }

    function actualizarRadar() {
        const getStats = (ids) => {
            if(!ids.length) return [0,0,0,0,0,0];
            const ps = ids.map(id => id>=9000?invitados.find(x=>x.id===id):datosOriginales.find(x=>x.id===id));
            const s = ps.reduce((acc,p)=>({ata:acc.ata+p.ata, def:acc.def+p.def, tec:acc.tec+p.tec, vel:acc.vel+p.vel, res:acc.res+p.res, arq:acc.arq+p.arq}),{ata:0,def:0,tec:0,vel:0,res:0,arq:0});
            return [s.ata/5, s.def/5, s.tec/5, s.vel/5, s.res/5, s.arq/5];
        };
        const d1 = getStats(equipo1), d2 = getStats(equipo2);
        if(!teamRadarChart) {
            teamRadarChart = new Chart(document.getElementById('radarChart'), {
                type: 'radar',
                data: { labels: ['ATA','DEF','TEC','VEL','RES','ARQ'], datasets: [
                    { label: 'CLARO', data: d1, borderColor: '#fff', backgroundColor: 'rgba(255,255,255,0.2)' },
                    { label: 'OSCURO', data: d2, borderColor: '#000', backgroundColor: 'rgba(0,0,0,0.4)' }
                ]},
                options: { scales: { r: { min: 30, max: 100, ticks: { display: false }, pointLabels: { color: '#fff', font: { family: 'Bebas Neue', size: 14 } } } }, plugins: { legend: { display: false } } }
            });
        } else { teamRadarChart.data.datasets[0].data = d1; teamRadarChart.data.datasets[1].data = d2; teamRadarChart.update(); }
    }

    function rotateMusic() {
        const p = document.getElementById('audio-player');
        volIndex = (volIndex + 1) % CONFIG.VOL_MUSICA.length;
        p.volume = CONFIG.VOL_MUSICA[volIndex];
        document.getElementById('music-control').innerText = ["", "", ""][volIndex];
        if(p.volume > 0) p.play(); else p.pause();
    }

    function initAudio() { 
        const p = document.getElementById('audio-player'); 
        p.src = CONFIG.URL_MUSICA; 
        p.volume = CONFIG.VOL_MUSICA[0]; 
        p.play().catch(()=>{}); 
    }

    function attachSounds() {
        const play = (id, vol) => { const s = document.getElementById(id); s.src = CONFIG[id.toUpperCase().replace('-PLAYER','')]; s.volume = vol; s.play().catch(()=>{}); };
        document.querySelectorAll('.btn, .card, .player-row').forEach(el => {
            if(!el.dataset.soundAttached) {
                el.addEventListener('mouseenter', () => play('sfx-hover-player', CONFIG.SFX_MAP[CONFIG.VOL_MUSICA[volIndex]]));
                el.addEventListener('mousedown', () => play('sfx-click-player', CONFIG.SFX_MAP[CONFIG.VOL_MUSICA[volIndex]] * 4));
                el.dataset.soundAttached = "true";
            }
        });
    }

    function descargarCarta() { 
        const el = document.getElementById('carta-descarga');
        el.querySelector('.shine-layer').style.display = 'none';
        html2canvas(el, { useCORS: true, scale: 3 }).then(cvs => {
            const a = document.createElement('a'); a.download = 'Carta.png'; a.href = cvs.toDataURL(); a.click();
            el.querySelector('.shine-layer').style.display = 'block';
        });
    }

    function compartirEquipos() {
        const area = document.getElementById('team-capture-area');
        html2canvas(area, { backgroundColor: '#1a1a1a', scale: 2 }).then(cvs => {
            cvs.toBlob(blob => {
                const file = new File([blob], "equipos.png", { type: "image/png" });
                if(navigator.share) navigator.share({ files: [file], title: 'Equipos' });
                else { const a = document.createElement('a'); a.download = 'Equipos.png'; a.href = cvs.toDataURL(); a.click(); }
            });
        });
    }

    function agregarInvitado() {
        if(equipo1.length + equipo2.length >= 10) return;
        const id = 9000 + invitados.length;
        invitados.push({id, nombre: "Invitado " + (invitados.length + 1), prom: 75, ata: 70, def: 70, tec: 70, vel: 70, res: 70, arq: 50});
        (equipo1.length <= equipo2.length ? equipo1 : equipo2).push(id);
        renderListaSeleccion();
    }
</script>
</body>
</html>
