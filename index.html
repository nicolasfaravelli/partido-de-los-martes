<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <title>Partido de los Martes</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    
    <style>
        /* =========================================
           1. CONFIGURACI√ìN GLOBAL
           ========================================= */
        :root {
            --fondo-url: none;
            --color-fondo: #0f0f0f;
            --color-paneles: #1a1a1a;
            --color-bordes: #333333;
            --color-texto: #ffffff;
            --color-acento: #d4af37; /* Dorado */
            --color-gris-claro: #f0f0f0;
            
            --stat-legend: #a855f7;
            --stat-gold: #d4af37;
            --stat-silver: #7a7a7a;
            --stat-bronze: #5e3e21;

            --fuente-titulo: 'Bebas Neue', sans-serif;
            --fuente-texto: 'Roboto', system-ui, sans-serif;
        }

        body { 
            background-color: var(--color-fondo); 
            color: var(--color-texto); 
            font-family: var(--fuente-titulo); 
            margin: 0; padding: 0 20px 20px 20px; 
            background-image: var(--fondo-url); background-position: center; background-repeat: no-repeat; background-size: cover; background-attachment: fixed;
            user-select: none;
        }

        /* =========================================
           2. HEADER Y CONTROLES PRINCIPALES
           ========================================= */
        .header-container { 
            text-align: center; position: sticky; top: 0; z-index: 100;
            margin: 0 -20px 10px -20px; padding: 20px 0 20px 0;
        }
        .header-container::before {
            content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; 
            background-color: var(--color-fondo); background-image: var(--fondo-url); 
            background-position: center; background-repeat: no-repeat; background-size: cover; background-attachment: fixed;
            opacity: 0.95; box-shadow: 0 10px 20px rgba(0,0,0,0.5); border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        h1 { margin: 0; letter-spacing: 2px; font-size: 2.5rem; color: var(--color-acento); }
        .title-img { max-width: 85%; height: auto; max-height: 120px; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.5)); transition: transform 0.1s; }
        .title-img:active { transform: scale(0.98); }

        .controls-area {
            max-width: 1200px; margin: 0 auto 20px auto; 
            display: flex; gap: 10px; flex-wrap: wrap;
            background: rgba(20, 20, 20, 0.95); padding: 15px; border-radius: 8px; border: 1px solid var(--color-bordes); 
            justify-content: space-between; align-items: center; position: relative; z-index: 50;
        }

        #search-input, #sort-select {
            flex: 1; padding: 10px 15px; font-family: var(--fuente-titulo); font-size: 1.1rem; letter-spacing: 1px;
            background: #2a2a2a; border: 1px solid #444; color: white; border-radius: 4px; min-width: 150px;
        }
        #search-input:focus, #sort-select:focus { outline: none; border-color: var(--color-acento); }

        .btn {
            border: 1px solid transparent; padding: 10px 20px; border-radius: 4px; cursor: pointer;
            font-family: var(--fuente-titulo); font-size: 1.3rem; letter-spacing: 1px;
            display: flex; align-items: center; gap: 8px; justify-content: center; transition: all 0.2s;
        }
        .btn:active { transform: scale(0.98); }

        .btn-gold { background: var(--color-acento); color: #000; border-color: var(--color-acento); font-weight: bold; }
        .btn-gold:hover { filter: brightness(1.1); }

        .btn-ghost { background: transparent; color: #aaa; border: 1px solid #444; }
        .btn-ghost:hover { color: #fff; border-color: #fff; }

        /* =========================================
           3. GRILLA DE JUGADORES (HOME)
           ========================================= */
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 20px; max-width: 1200px; margin: 0 auto; padding-bottom: 50px; }
        
        .card { position: relative; width: 100%; aspect-ratio: 2 / 3; cursor: pointer; transition: transform 0.2s ease-out; container-type: size; transform: translateZ(0); -webkit-tap-highlight-color: transparent; }
        .card:hover { transform: scale(1.05); z-index: 10; }

        .card-bg-wrapper { position: absolute; top: 0; left: 0; width: 100%; height: 100%; overflow: hidden; display: block; filter: drop-shadow(0 5px 6px rgba(0,0,0,0.6)); z-index: 1; }
        .card-bg { width: 100%; height: 100%; object-fit: contain; display: block; }
        .card-face { position: absolute; z-index: 2; top: 9.75%; left: 5.25%; width: 95%; object-fit: contain; display: block; }
        .info-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 3; pointer-events: none; }

        .rating { position: absolute; top: 13.5%; left: 6%; font-size: 18cqw; text-align: center; width: 25%; line-height: 0.8; }
        .position { position: absolute; top: 24%; left: 6%; font-size: 10cqw; text-align: center; width: 25%; line-height: 1; }
        .name { position: absolute; top: 64.25%; left: 5%; width: 90%; text-align: center; font-size: 14.5cqw; text-transform: uppercase; letter-spacing: 1px; }
        .stats-container { display: flex; justify-content: space-between; position: absolute; top: 81%; left: 8%; width: 84.1%; }
        .stat-box { text-align: center; width: 16%; }
        .stat-val { font-size: 8.5cqw; display: block; }

        .shine-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 4; pointer-events: none; overflow: hidden; -webkit-mask-size: contain; mask-size: contain; mask-repeat: no-repeat; mask-position: center; }
        .shine-layer::after { content: ""; position: absolute; top: 0; left: -100%; width: 50%; height: 100%; background: linear-gradient(to right, rgba(255,255,255,0) 0%, rgba(255,255,255,0.3) 50%, rgba(255,255,255,0) 100%); transform: skewX(-25deg); transition: none; }
        .card:hover .shine-layer::after { left: 150%; transition: left 0.6s; }
        
        @keyframes shine-sweep { 0% { left: -100%; } 100% { left: 150%; } }
        .card.trigger-shine .shine-layer::after { animation: shine-sweep 0.7s ease-out forwards; }
        
        @keyframes shine-sweep-reverse { 0% { left: 150%; } 100% { left: -100%; } }
        .card.trigger-shine-reverse .shine-layer::after { animation: shine-sweep-reverse 0.7s ease-out forwards; }

        /* =========================================
           4. MODALES
           ========================================= */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 3000; flex-direction: column; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        #modal-card-container { width: 340px; aspect-ratio: 2 / 3; margin-bottom: 20px; filter: drop-shadow(0 0 20px rgba(0,0,0,0.5)); }
        
        .btn-group { display: flex; gap: 15px; justify-content: center; width: 100%; flex-wrap: wrap; margin-top: 10px; }

        /* =========================================
           5. ARMADOR DE EQUIPOS (MODAL)
           ========================================= */
        #team-modal-content { background: var(--color-paneles); padding: 20px; border-radius: 8px; border: 1px solid var(--color-bordes); width: 95%; max-width: 900px; max-height: 95vh; display: flex; flex-direction: column; }
        
        .team-title { text-align: center; color: var(--color-acento); margin: 0 0 10px 0; font-size: 2rem; }
        
        .armador-layout { display: flex; flex-direction: column; gap: 15px; overflow-y: auto; flex: 1; padding-right: 5px; }
        
        .selection-area { background: #111; padding: 10px; border-radius: 6px; border: 1px solid #333; }
        
        .selection-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; border-bottom: 1px solid #333; padding-bottom: 10px; gap: 15px; }
        .counter-text { font-family: var(--fuente-texto); font-weight: bold; color: #888; text-transform: uppercase; font-size: 1.1rem; }
        .counter-text.complete { color: var(--color-acento); }

        .players-list-scroll { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 8px; max-height: 200px; overflow-y: auto; }
        
        .player-row { 
            display: flex; align-items: center; gap: 10px; padding: 8px; background: #252525; border-radius: 4px; cursor: pointer; transition: background 0.2s; 
            font-family: var(--fuente-texto); font-size: 0.95rem; font-weight: bold; border: 1px solid transparent;
        }
        .player-row:hover { background: #333; }
        .player-row.selected { background: #2a2a2a; border-color: var(--color-acento); color: var(--color-acento); }
        .player-row.disabled { opacity: 0.3; pointer-events: none; }
        .player-check { transform: scale(1.2); accent-color: var(--color-acento); cursor: pointer; margin: 0; }
        
        .guest-item { border: 1px dashed #555; background: #1a1a1a; }
        .guest-input-name { background: transparent; border: none; border-bottom: 1px solid #555; color: white; width: 90px; font-family: var(--fuente-texto); font-size: 0.9rem; }
        .guest-input-name:focus { outline: none; border-color: var(--color-acento); }
        .guest-input-rating { background: #111; border: 1px solid #444; color: var(--color-acento); width: 30px; text-align: center; border-radius: 3px; font-weight: bold; }

        .btn-add-guest { 
            width: auto; 
            padding: 8px 15px; 
            background: #222; 
            border: 1px dashed #444; 
            color: #888; 
            font-family: var(--fuente-titulo); 
            font-size: 1.1rem; 
            cursor: pointer; 
            border-radius: 4px; 
            transition: all 0.2s; 
            white-space: nowrap;
        }
        .btn-add-guest:hover { background: #2a2a2a; color: var(--color-acento); border-color: var(--color-acento); }

        .tools-area { display: flex; justify-content: center; gap: 10px; align-items: center; }
        .btn-generate { width: 100%; max-width: 300px; font-size: 1.5rem; padding: 12px; }

        #team-capture-area { background: var(--color-paneles); border-radius: 8px; margin-top: 10px; }
        .teams-container { display: flex; gap: 15px; margin-top: 5px; min-height: 250px; }
        .team-box { flex: 1; padding: 10px; border-radius: 6px; border: 2px solid #333; display: flex; flex-direction: column; transition: border-color 0.2s; }
        
        .team-box.drag-over { border-color: var(--color-acento); background: rgba(212, 175, 55, 0.05); }

        .team-white { background: var(--color-gris-claro); color: #111; border-color: #fff; }
        .team-black { background: #111; color: #fff; border-color: #333; }
        
        .team-header { font-size: 1.8rem; text-align: center; border-bottom: 2px solid; margin-bottom: 5px; font-weight: bold; letter-spacing: 1px; }
        .team-avg { text-align: center; font-size: 1rem; margin-bottom: 10px; opacity: 0.8; font-family: var(--fuente-texto); font-weight: bold; }
        
        .team-list-ul { list-style: none; padding: 0; margin: 0; flex: 1; display: flex; flex-direction: column; gap: 5px; }
        
        .team-player-li { 
            padding: 8px 10px; border-bottom: 1px solid rgba(0,0,0,0.1); font-size: 1.1rem; font-family: var(--fuente-texto); font-weight: bold; 
            display: flex; justify-content: space-between; align-items: center; cursor: grab; background: rgba(255,255,255,0.05); border-radius: 4px;
            user-select: none; transition: transform 0.1s, background 0.2s;
        }
        .team-black .team-player-li { border-bottom: 1px solid rgba(255,255,255,0.1); }
        .team-player-li:active { cursor: grabbing; transform: scale(0.98); }
        .team-player-li:hover { background: rgba(128,128,128,0.2); }
        
        .modal-footer { margin-top: 15px; display: flex; justify-content: space-between; gap: 10px; border-top: 1px solid #333; padding-top: 15px; }

        #loader { text-align: center; color: #666; margin-top: 50px; font-family: sans-serif;}
        body.retro-mode { filter: sepia(0.4) contrast(1.2) brightness(0.9); }
    </style>
</head>
<body>

    <div class="header-container" id="header-area" ondblclick="activarModoRetro()" title="Doble click para Modo Retro">
        <h1 id="default-title">PARTIDO DE LOS MARTES</h1>
    </div>
    
    <div class="controls-area">
        <input type="text" id="search-input" placeholder="Buscar jugador...">
        <select id="sort-select">
            <option value="nombre-asc">Nombre: A - Z</option>
            <option value="nombre-desc">Nombre: Z - A</option>
            <option value="prom-desc">Valoraci√≥n: Mayor a Menor</option>
            <option value="prom-asc">Valoraci√≥n: Menor a Mayor</option>
        </select>
        <button class="btn btn-gold" onclick="abrirArmador()">
            ARMAR EQUIPOS
        </button>
    </div>

    <div id="loader">Cargando jugadores...</div>
    <div id="grid-container" class="grid"></div>

    <div id="modal" class="modal-overlay">
        <div id="modal-card-container"></div>
        <div class="btn-group" id="modal-buttons"></div>
    </div>

    <div id="team-modal" class="modal-overlay">
        <div id="team-modal-content">
            <div class="team-title">ARMADOR DE EQUIPOS</div>
            
            <div class="armador-layout">
                <div class="selection-area">
                    <div class="selection-header">
                        <span class="counter-text" id="team-counter">SELECCIONADOS: 0/10</span>
                        <button class="btn-add-guest" onclick="agregarInvitado()">+ AGREGAR INVITADO</button>
                    </div>
                    <div id="players-checklist" class="players-list-scroll"></div>
                </div>

                <div class="tools-area">
                    <button class="btn btn-gold btn-generate" onclick="generarAutomatico()" id="btn-generate" style="opacity: 0.5; pointer-events: none;">
                        GENERAR AUTOM√ÅTICO
                    </button>
                </div>

                <div id="team-capture-area">
                    <div class="teams-container">
                        <div class="team-box team-white" id="box-team-1" ondragover="permitirDrop(event)" ondrop="dropJugador(event, 'team1')">
                            <div class="team-header">CLARO</div>
                            <div class="team-avg" id="avg-team-1">Prom: 0</div>
                            <ul class="team-list-ul" id="list-team-1"></ul>
                        </div>
                        
                        <div class="team-box team-black" id="box-team-2" ondragover="permitirDrop(event)" ondrop="dropJugador(event, 'team2')">
                            <div class="team-header">OSCURO</div>
                            <div class="team-avg" id="avg-team-2">Prom: 0</div>
                            <ul class="team-list-ul" id="list-team-2"></ul>
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn btn-gold" onclick="compartirEquipos()" id="btn-share-teams" style="display:none;">COMPARTIR</button>
                <div style="flex:1"></div>
                <button class="btn btn-ghost" onclick="cerrarArmador()">CERRAR</button>
            </div>
        </div>
    </div>

    <audio id="audio-player" loop></audio>
    <div style="position:fixed; bottom:20px; right:20px; font-size:2rem; cursor:pointer;" onclick="toggleMusic()">üîà</div>

<script>
    // ====================================================================
    //   CONFIGURACI√ìN
    // ====================================================================
    const FONDO_URL = "https://raw.githubusercontent.com/nicolasfaravelli/partido-de-los-martes/main/Fondo.png"; 
    const TITULO_IMG_URL = "https://raw.githubusercontent.com/nicolasfaravelli/partido-de-los-martes/main/Titulo.png";
    const MUSICA_URL = "https://raw.githubusercontent.com/nicolasfaravelli/partido-de-los-martes/main/Musica.mp3";
    const LEYENDA_FONDO_URL = "https://raw.githubusercontent.com/nicolasfaravelli/partido-de-los-martes/main/LEYENDA.png";
    
    const BASE_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTHOyW-OmPwPBpIwBw30sBjYdcLn1_8xFjkXfG9_tLFeB960jfYnnouTDieGPeKSK49FYM1tSGng_mg/pub?gid=1826229647&single=true&output=csv";
    const NEW_CSV_URL = BASE_CSV_URL + "&uid=" + Date.now();
    const PROXY_URL = "https://corsproxy.io/?" + encodeURIComponent(NEW_CSV_URL);

    const COLORES = { 'leyenda': '#644b14', 'legendario': '#372864', 'oro': '#624f21', 'plata': '#434343', 'bronce': '#5e3e21' };
    const STAT_COLORS = { 'legend': '#a855f7', 'gold': '#d4af37', 'silver': '#7a7a7a', 'bronze': '#5e3e21' };

    const MULTIPLICADORES_RANKING = [1.125, 1.1, 1.075, 1.05, 1.025, 1]; 
    const BONUS_FISICO = { 'res': 1.05, 'vel': 1.025 };
    const TOPE_MAXIMO = 98;

    // ====================================================================
    //   ESTADO GLOBAL
    // ====================================================================
    let datosOriginales = [];
    let invitados = []; 
    let equipo1 = []; // IDs en equipo 1
    let equipo2 = []; // IDs en equipo 2
    let draggingId = null;
    let jugadorActualEnModal = null;
    let esModoLeyenda = false;

    document.addEventListener("DOMContentLoaded", function() {
        if(FONDO_URL) document.documentElement.style.setProperty('--fondo-url', `url('${FONDO_URL}')`);
        if(TITULO_IMG_URL) document.getElementById('header-area').innerHTML = `<img src="${TITULO_IMG_URL}" class="title-img">`;
        if(MUSICA_URL) document.getElementById('audio-player').src = MUSICA_URL;
        cargarDatos();
    });

    function cargarDatos() {
        Papa.parse(PROXY_URL, {
            download: true, header: false, skipEmptyLines: true,
            complete: function(results) {
                const data = results.data;
                document.getElementById('loader').style.display = 'none';
                if(data.length > 0) data.shift();
                
                datosOriginales = data.map((fila, index) => {
                    if(!fila[0] || fila[0] === 'Jugador') return null;
                    return {
                        id: index,
                        nombre: fila[0],
                        prom: parseInt(fila[8]) || 60,
                        ata: parseInt(fila[2]), def: parseInt(fila[3]), tec: parseInt(fila[4]),
                        vel: parseInt(fila[5]), res: parseInt(fila[6]), arq: parseInt(fila[7]),
                        edad: parseInt(fila[1]) || 25,
                        pos: fila[9], fondo: fila[11], foto: fila[12], fotoLeyenda: fila[13],
                        color: COLORES[fila[10] ? fila[10].trim().toLowerCase() : 'oro'] || '#624f21'
                    };
                }).filter(i => i !== null);
                
                aplicarFiltrosYOrden();
            }
        });
    }

    const searchInput = document.getElementById('search-input');
    const sortSelect = document.getElementById('sort-select');
    
    if(searchInput) searchInput.addEventListener('input', aplicarFiltrosYOrden);
    if(sortSelect) sortSelect.addEventListener('change', aplicarFiltrosYOrden);

    function aplicarFiltrosYOrden() {
        const texto = searchInput.value.toLowerCase();
        const val = sortSelect.value.split('-');
        const criterio = val[0];
        const orden = val[1];

        let lista = datosOriginales.filter(j => j.nombre.toLowerCase().includes(texto));

        lista.sort((a,b) => {
            if(criterio === 'nombre') {
                return orden === 'asc' ? a.nombre.localeCompare(b.nombre) : b.nombre.localeCompare(a.nombre);
            }
            if(criterio === 'prom') {
                return orden === 'asc' ? a.prom - b.prom : b.prom - a.prom;
            }
        });
        
        renderizarGrilla(lista);
    }

    function renderizarGrilla(lista) {
        const container = document.getElementById('grid-container');
        container.innerHTML = '';
        if(lista.length === 0) { container.innerHTML = '<p style="text-align:center;color:#aaa">No se encontraron jugadores.</p>'; return; }
        lista.forEach(j => {
            container.innerHTML += `<div class="card" onclick="abrirModal(${j.id})">${generarHTMLCarta(j, true)}</div>`;
        });
    }

    function generarHTMLCarta(j, lazy) {
        const load = lazy ? 'loading="lazy"' : '';
        const fotoHtml = j.foto ? `<img src="${j.foto}" class="card-face" ${load} crossorigin="anonymous">` : '';
        return `
            <div class="card-bg-wrapper"><img src="${j.fondo}" class="card-bg" ${load} crossorigin="anonymous"></div>
            <div class="shine-layer" style="-webkit-mask-image: url('${j.fondo}'); mask-image: url('${j.fondo}');"></div>
            ${fotoHtml}
            <div class="info-layer">
                <div class="rating" style="color:${j.color}">${j.prom}</div>
                <div class="position" style="color:${j.color}">${j.pos}</div>
                <div class="name" style="color:${j.color}">${j.nombre}</div>
                <div class="stats-container" style="color:${j.color}">
                    <div class="stat-box"><span class="stat-val">${j.ata}</span></div>
                    <div class="stat-box"><span class="stat-val">${j.def}</span></div>
                    <div class="stat-box"><span class="stat-val">${j.tec}</span></div>
                    <div class="stat-box"><span class="stat-val">${j.vel}</span></div>
                    <div class="stat-box"><span class="stat-val">${j.res}</span></div>
                    <div class="stat-box"><span class="stat-val">${j.arq}</span></div>
                </div>
            </div>`;
    }

    function abrirModal(id) {
        const j = datosOriginales.find(x => x.id === id);
        jugadorActualEnModal = j;
        esModoLeyenda = false;
        
        const modal = document.getElementById('modal');
        modal.style.display = 'flex';
        renderizarModal(j);
    }

    function renderizarModal(j) {
        const cont = document.getElementById('modal-card-container');
        const btns = document.getElementById('modal-buttons');
        
        cont.innerHTML = `<div class="card" id="carta-descarga">${generarHTMLCarta(j, false)}</div>`;
        
        let htmlBtns = '';
        if (jugadorActualEnModal.fotoLeyenda) {
            const txt = esModoLeyenda ? "ACTUAL" : "LEYENDA";
            const cls = esModoLeyenda ? "btn-ghost" : "btn-gold";
            htmlBtns += `<button class="btn ${cls}" onclick="toggleLeyenda()">${txt}</button>`;
        }
        
        htmlBtns += `<button class="btn btn-gold" onclick="descargarCarta()">DESCARGAR</button>`;
        htmlBtns += `<button class="btn btn-ghost" onclick="document.getElementById('modal').style.display='none'">CERRAR</button>`;
        
        btns.innerHTML = htmlBtns;
    }

    function toggleLeyenda() {
        esModoLeyenda = !esModoLeyenda;
        let mostrar;
        if(esModoLeyenda) mostrar = calcularObjetoLeyenda(jugadorActualEnModal);
        else mostrar = jugadorActualEnModal;
        
        renderizarModal(mostrar);

        const card = document.getElementById('carta-descarga');
        if(card) {
            card.classList.remove('trigger-shine', 'trigger-shine-reverse');
            void card.offsetWidth;
            card.classList.add(esModoLeyenda ? 'trigger-shine' : 'trigger-shine-reverse');
        }
    }

    function calcularObjetoLeyenda(base) {
        let stats = [
            { id: 'ata', valor: base.ata }, { id: 'def', valor: base.def },
            { id: 'tec', valor: base.tec }, { id: 'vel', valor: base.vel },
            { id: 'res', valor: base.res }, { id: 'arq', valor: base.arq }
        ];
        stats.sort((a, b) => b.valor - a.valor);
        
        let nuevos = {};
        stats.forEach((obj, idx) => {
            let mult = MULTIPLICADORES_RANKING[idx] || 1.05;
            let val = obj.valor * mult;
            if (BONUS_FISICO[obj.id]) val *= BONUS_FISICO[obj.id];
            nuevos[obj.id] = Math.min(TOPE_MAXIMO, Math.round(val));
        });

        let suma = 0; 
        for(let k in nuevos) suma += nuevos[k];
        let prom = Math.min(99, Math.round(suma/6));

        return {
            ...base,
            foto: base.fotoLeyenda,
            fondo: LEYENDA_FONDO_URL,
            color: COLORES['leyenda'],
            ata: nuevos.ata, def: nuevos.def, tec: nuevos.tec,
            vel: nuevos.vel, res: nuevos.res, arq: nuevos.arq,
            prom: prom
        };
    }

    function descargarCarta() {
        const el = document.getElementById('carta-descarga');
        const shine = el.querySelector('.shine-layer');
        shine.style.display = 'none';
        html2canvas(el, { useCORS: true, scale: 3, backgroundColor: null }).then(cvs => {
            const a = document.createElement('a'); a.download = 'Carta.png'; a.href = cvs.toDataURL(); a.click();
            shine.style.display = 'block';
        });
    }

    function abrirArmador() {
        document.getElementById('team-modal').style.display = 'flex';
        invitados = []; 
        renderizarListaSeleccion();
        limpiarEquipos();
    }
    
    function cerrarArmador() {
        document.getElementById('team-modal').style.display = 'none';
    }

    function agregarInvitado() {
        const num = invitados.length + 1;
        const idInv = 9000 + num; 
        
        const nuevoInvitado = {
            id: idInv,
            nombre: `Invitado ${num}`,
            prom: 70,
            esInvitado: true,
            ata: 70, def: 70, tec: 70, vel: 70, res: 70, arq: 50, edad: 25
        };

        invitados.push(nuevoInvitado);
        asignarJugadorAutomaticamente(idInv);
        renderizarListaSeleccion();
        actualizarContadorEquipos();
    }

    function borrarInvitado(idInv) {
        invitados = invitados.filter(i => i.id !== idInv);
        removerJugadorDeEquipos(idInv);
        renderizarListaSeleccion();
        actualizarContadorEquipos();
    }

    function editarInvitado(idInv, campo, valor) {
        const inv = invitados.find(i => i.id === idInv);
        if(inv) {
            if(campo === 'nombre') inv.nombre = valor;
            if(campo === 'prom') {
                const v = parseInt(valor) || 60;
                inv.prom = v;
                inv.ata=v; inv.def=v; inv.tec=v; inv.vel=v; inv.res=v;
            }
            actualizarTablerosEquipos(); 
        }
    }

    function renderizarListaSeleccion() {
        const contenedor = document.getElementById('players-checklist');
        contenedor.innerHTML = '';

        invitados.forEach(inv => {
            const div = document.createElement('div');
            div.className = 'player-row guest-item selected';
            div.innerHTML = `
                <input type="checkbox" class="player-check" checked value="${inv.id}" onchange="toggleSeleccion(${inv.id})">
                <input type="text" class="guest-input-name" value="${inv.nombre}" oninput="editarInvitado(${inv.id}, 'nombre', this.value)" onclick="event.stopPropagation()">
                <input type="number" class="guest-input-rating" value="${inv.prom}" onchange="editarInvitado(${inv.id}, 'prom', this.value)" onclick="event.stopPropagation()">
                <span style="color:#f55; font-weight:bold; margin-left:auto; cursor:pointer;" onclick="borrarInvitado(${inv.id})">‚úï</span>
            `;
            contenedor.appendChild(div);
        });

        const sorted = [...datosOriginales].sort((a,b) => a.nombre.localeCompare(b.nombre));
        
        sorted.forEach(j => {
            const isSelected = isPlayerSelected(j.id);
            const rowClass = isSelected ? 'player-row selected' : 'player-row';
            
            const div = document.createElement('div');
            div.className = rowClass;
            div.id = `row-${j.id}`;
            div.onclick = (e) => { 
                if(e.target.type !== 'checkbox') {
                    const cb = div.querySelector('.player-check');
                    if(!cb.disabled) {
                        cb.checked = !cb.checked;
                        toggleSeleccion(j.id);
                    }
                }
            };

            div.innerHTML = `
                <input type="checkbox" class="player-check" value="${j.id}" ${isSelected ? 'checked' : ''} onchange="toggleSeleccion(${j.id})">
                <span>${j.nombre}</span>
                <span style="margin-left:auto; color:#666; font-size:0.8em">${j.prom}</span>
            `;
            contenedor.appendChild(div);
        });
        
        actualizarContadorEquipos();
    }

    function isPlayerSelected(id) {
        return equipo1.includes(id) || equipo2.includes(id); 
    }

    function toggleSeleccion(id) {
        const checkbox = document.querySelector(`.player-check[value="${id}"]`);
        const isChecked = checkbox ? checkbox.checked : true;
        const row = document.getElementById(`row-${id}`);

        if (isChecked) {
            if(row) row.classList.add('selected');
            asignarJugadorAutomaticamente(id);
        } else {
            if(row) row.classList.remove('selected');
            removerJugadorDeEquipos(id);
        }
        actualizarContadorEquipos();
    }

    function asignar
